<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Teacher Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ink: #1a1a2e; --teal: #0f7b6c; --teal-light: #13a88f;
            --gold: #f5a623; --rose: #e05263; --violet: #7c5cbf;
            --orange: #e67e22; --blue: #2e86de;
            --bg: #f4f6f0; --card: #ffffff; --muted: #7a8b8a;
            --border: #e0e8e6; --success: #2ecc71;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--ink); min-height: 100vh; padding-bottom: 80px; }

        /* HEADER */
        .header { background: var(--ink); padding: 16px 20px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
        .app-title { font-family: 'Baloo 2', cursive; font-size: 1.3em; font-weight: 800; color: white; letter-spacing: -0.5px; }
        .app-title span { color: var(--gold); }
        .header-actions { display: flex; gap: 8px; }
        .hbtn { padding: 7px 12px; border: none; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif; letter-spacing: 0.3px; transition: all 0.2s; }
        .hbtn-export { background: var(--gold); color: var(--ink); }
        .hbtn-import { background: rgba(255,255,255,0.12); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .hbtn:active { transform: scale(0.95); }

        /* TABS */
        .tabs { display: flex; gap: 2px; overflow-x: auto; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .tab { flex: 1; padding: 11px 6px 13px; text-align: center; color: rgba(255,255,255,0.45); cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 700; font-size: 9.5px; text-transform: uppercase; letter-spacing: 0.6px; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.2s; min-width: 50px; }
        .tab.active { color: var(--gold); border-bottom-color: var(--gold); }

        /* PAGES */
        .page { display: none; padding: 18px; max-width: 680px; margin: auto; }
        .page.active { display: block; }

        /* CARDS */
        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
        .card-title { font-family: 'Baloo 2', cursive; font-size: 1.05em; font-weight: 800; color: var(--teal); margin-bottom: 16px; padding-bottom: 10px; border-bottom: 2px solid var(--border); display: flex; align-items: center; gap: 8px; }

        /* FORM */
        label { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; margin-top: 14px; display: block; }
        select, input[type="date"], input[type="text"], input[type="tel"], input[type="number"], textarea {
            width: 100%; padding: 11px 14px; margin-top: 6px; border: 1.5px solid var(--border); border-radius: 10px;
            font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--ink); background: #fafcfb; transition: border-color 0.2s; appearance: none;
        }
        select:focus, input:focus, textarea:focus { outline: none; border-color: var(--teal); background: white; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .input-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

        /* BUTTONS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-family: 'Baloo 2', cursive; font-size: 1em; font-weight: 600; margin-top: 12px; transition: all 0.2s; letter-spacing: 0.3px; }
        .btn:active { transform: scale(0.98); }
        .btn-main   { background: var(--teal);   color: white; }
        .btn-main:hover { background: var(--teal-light); }
        .btn-wa     { background: #25D366; color: white; }
        .btn-violet { background: var(--violet);  color: white; }
        .btn-blue   { background: var(--blue);    color: white; }
        .btn-orange { background: var(--orange);  color: white; }
        .btn-rose   { background: var(--rose);    color: white; font-size: 0.85em; padding: 10px; }

        /* Q LIST */
        .q-list { margin-top: 10px; border: 1.5px solid var(--border); border-radius: 12px; max-height: 260px; overflow-y: auto; background: #fafcfb; }
        .q-row { display: grid; grid-template-columns: 32px 1fr 115px; align-items: center; gap: 8px; padding: 9px 12px; border-bottom: 1px solid #eef2f0; transition: background 0.15s; }
        .q-row:last-child { border-bottom: none; }
        .q-row:hover { background: #f0f7f5; }
        .q-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--teal); margin: 0; padding: 0; cursor: pointer; border: none; background: none; }
        .q-label { font-size: 13px; font-weight: 500; }
        .type-select { font-size: 11px; padding: 5px 8px; height: 30px; border-radius: 6px; border: 1.5px solid var(--border); background: white; font-family: 'DM Sans', sans-serif; color: var(--ink); cursor: pointer; }

        /* ASSIGN ROWS */
        .assign-row { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-bottom: 1px solid #eef2f0; cursor: pointer; transition: background 0.15s; }
        .assign-row:last-child { border-bottom: none; }
        .assign-row:hover { background: #f0f7f5; }
        .assign-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--teal); cursor: pointer; flex-shrink: 0; }
        .assign-row span { font-size: 13px; font-weight: 500; }
        .assign-box { margin-top: 14px; background: #fafcfb; border: 1.5px solid var(--border); border-radius: 12px; overflow: hidden; }

        /* STUDENT CARDS */
        .student-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 4px; }
        .student-card { background: var(--bg); border: 1.5px solid var(--border); border-radius: 14px; padding: 14px; position: relative; transition: all 0.2s; cursor: pointer; }
        .student-card:hover { border-color: var(--teal); box-shadow: 0 4px 16px rgba(15,123,108,0.1); }
        .student-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 1.1em; color: white; flex-shrink: 0; }
        .student-name { font-weight: 700; font-size: 13px; color: var(--ink); line-height: 1.2; }
        .student-meta { font-size: 11px; color: var(--muted); margin-top: 3px; }
        .student-badge { display: inline-block; background: var(--teal); color: white; font-size: 9px; font-weight: 700; padding: 2px 7px; border-radius: 10px; margin-top: 5px; letter-spacing: 0.3px; }
        .student-delete { position: absolute; top: 8px; right: 8px; background: none; border: none; color: #ccc; cursor: pointer; font-size: 14px; padding: 2px; transition: color 0.2s; }
        .student-delete:hover { color: var(--rose); }

        /* STUDENT DETAIL */
        .student-detail-header { display: flex; align-items: center; gap: 14px; margin-bottom: 16px; padding-bottom: 14px; border-bottom: 2px solid var(--border); }
        .student-detail-avatar { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 1.4em; color: white; flex-shrink: 0; }
        .student-detail-info h3 { font-family: 'Baloo 2', cursive; font-size: 1.1em; font-weight: 800; color: var(--ink); }
        .student-detail-info p { font-size: 12px; color: var(--muted); margin-top: 2px; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .info-row:last-child { border-bottom: none; }
        .info-row .info-key { color: var(--muted); font-weight: 600; font-size: 12px; }
        .info-row .info-val { font-weight: 700; }

        /* SEARCH + PILLS */
        .search-wrap { position: relative; margin-bottom: 14px; }
        .search-wrap input { padding-left: 38px; border-radius: 10px; margin-top: 0; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 15px; pointer-events: none; }
        .pill-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
        .pill { padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; border: 1.5px solid var(--border); background: white; color: var(--muted); transition: all 0.2s; }
        .pill.active { background: var(--teal); color: white; border-color: var(--teal); }

        /* NOTEBOOK */
        .nb-table { width: 100%; border-collapse: collapse; }
        .nb-table th { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); padding: 8px 10px; text-align: left; border-bottom: 2px solid var(--border); }
        .nb-table td { padding: 10px; border-bottom: 1px solid #eef2f0; vertical-align: middle; }
        .nb-table tr:last-child td { border-bottom: none; }
        .nb-table tr:hover td { background: #f8fbfa; }
        .nb-student-info { display: flex; align-items: center; gap: 8px; }
        .nb-avatar { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 0.75em; color: white; flex-shrink: 0; }
        .nb-name { font-size: 13px; font-weight: 600; }
        .nb-roll { font-size: 11px; color: var(--muted); }
        .status-btns { display: flex; gap: 5px; }
        .status-btn { padding: 5px 10px; border: 1.5px solid var(--border); border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; background: white; color: var(--muted); transition: all 0.15s; font-family: 'DM Sans', sans-serif; white-space: nowrap; }
        .status-btn.active-submitted  { background: #e8f8f0; color: #0f7b6c; border-color: #0f7b6c; }
        .status-btn.active-incomplete { background: #fff4e0; color: #e67e22; border-color: #e67e22; }
        .status-btn.active-missing    { background: #fdecea; color: #e05263; border-color: #e05263; }
        .nb-remarks-input { width: 100%; padding: 6px 10px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 12px; font-family: 'DM Sans', sans-serif; color: var(--ink); background: #fafcfb; transition: border-color 0.2s; }
        .nb-remarks-input:focus { outline: none; border-color: var(--teal); background: white; }
        .nb-summary { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
        .nb-sum-pill { flex: 1; min-width: 70px; padding: 10px; border-radius: 10px; text-align: center; }
        .nb-sum-pill .nb-sum-num { font-family: 'Baloo 2', cursive; font-size: 1.6em; font-weight: 800; line-height: 1; }
        .nb-sum-pill .nb-sum-label { font-size: 10px; font-weight: 700; margin-top: 3px; }
        .nb-sum-submitted  { background: #e8f8f0; color: #0f7b6c; }
        .nb-sum-incomplete { background: #fff4e0; color: #e67e22; }
        .nb-sum-missing    { background: #fdecea; color: #e05263; }
        .nb-sum-total      { background: var(--bg); color: var(--ink); border: 1.5px solid var(--border); }
        .nb-history-entry { background: var(--bg); border-radius: 12px; padding: 14px; margin-bottom: 10px; border-left: 4px solid var(--orange); cursor: pointer; }
        .nb-history-meta { font-size: 11px; color: var(--muted); font-weight: 700; margin-bottom: 6px; }
        .nb-history-title { font-size: 14px; font-weight: 700; margin-bottom: 8px; }
        .nb-history-stats { display: flex; gap: 8px; flex-wrap: wrap; }
        .nb-stat-chip { font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 10px; }
        .chip-submitted  { background: #e8f8f0; color: #0f7b6c; }
        .chip-incomplete { background: #fff4e0; color: #e67e22; }
        .chip-missing    { background: #fdecea; color: #e05263; }
        .nb-scroll { overflow-x: auto; border-radius: 10px; border: 1.5px solid var(--border); }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           TEST RECORDS STYLES (PHASE 4)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        /* Marks entry table */
        .marks-table { width: 100%; border-collapse: collapse; }
        .marks-table th { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); padding: 8px 10px; text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
        .marks-table td { padding: 8px 10px; border-bottom: 1px solid #eef2f0; vertical-align: middle; }
        .marks-table tr:last-child td { border-bottom: none; }
        .marks-table tr:hover td { background: #f8fbfa; }

        .marks-input {
            width: 70px; padding: 7px 10px; border: 1.5px solid var(--border);
            border-radius: 8px; font-size: 14px; font-weight: 700; text-align: center;
            font-family: 'DM Sans', sans-serif; color: var(--ink); background: #fafcfb;
            transition: border-color 0.2s;
        }
        .marks-input:focus { outline: none; border-color: var(--teal); background: white; }
        .marks-input.above-avg { border-color: var(--teal); }
        .marks-input.below-avg { border-color: var(--rose); }

        /* Grade badge */
        .grade-badge {
            display: inline-flex; align-items: center; justify-content: center;
            width: 34px; height: 34px; border-radius: 50%;
            font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 0.85em;
            flex-shrink: 0;
        }
        .grade-A { background: #d4edda; color: #155724; }
        .grade-B { background: #d1ecf1; color: #0c5460; }
        .grade-C { background: #fff3cd; color: #856404; }
        .grade-D { background: #fdecea; color: #721c24; }
        .grade-F { background: #f8d7da; color: #491217; }
        .grade-X { background: var(--bg); color: var(--muted); }

        /* Analytics cards */
        .analytics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
        .an-card { background: var(--bg); border-radius: 12px; padding: 12px; text-align: center; border: 1.5px solid var(--border); }
        .an-num { font-family: 'Baloo 2', cursive; font-size: 1.5em; font-weight: 800; color: var(--teal); line-height: 1; }
        .an-label { font-size: 10px; color: var(--muted); font-weight: 700; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Grade distribution bar */
        .grade-dist { margin-top: 14px; }
        .grade-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .grade-bar-label { font-size: 12px; font-weight: 700; width: 22px; text-align: center; }
        .grade-bar-bg { flex: 1; background: var(--border); border-radius: 4px; height: 10px; overflow: hidden; }
        .grade-bar-fill { height: 10px; border-radius: 4px; transition: width 0.5s; }
        .grade-bar-count { font-size: 11px; font-weight: 700; color: var(--muted); width: 20px; text-align: right; }

        /* Test history card */
        .test-history-card {
            background: var(--bg); border-radius: 12px; padding: 14px;
            margin-bottom: 10px; border-left: 4px solid var(--blue);
            cursor: pointer; transition: box-shadow 0.15s;
        }
        .test-history-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
        .test-history-meta { font-size: 11px; color: var(--muted); font-weight: 700; margin-bottom: 4px; }
        .test-history-title { font-size: 14px; font-weight: 700; margin-bottom: 8px; }
        .test-chips { display: flex; gap: 8px; flex-wrap: wrap; }
        .test-chip { font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 10px; }
        .chip-avg   { background: #e8f4fd; color: var(--blue); }
        .chip-top   { background: #e8f8f0; color: #0f7b6c; }
        .chip-low   { background: #fdecea; color: var(--rose); }
        .chip-pass  { background: #d4edda; color: #155724; }

        /* Topper row highlight */
        .topper-row td { background: #f0fbf6 !important; }
        .low-row td    { background: #fff5f5 !important; }

        /* Absent marker */
        .absent-toggle { font-size: 11px; font-weight: 700; color: var(--muted); cursor: pointer; padding: 4px 8px; border-radius: 6px; border: 1.5px solid var(--border); background: white; font-family: 'DM Sans', sans-serif; white-space: nowrap; transition: all 0.15s; }
        .absent-toggle.marked { background: #fdecea; color: var(--rose); border-color: var(--rose); }

        /* BULK UPLOAD */
        #bulkDropZone.drag-over { border-color: var(--teal); background: #f0f7f5; }
        #bulkDropZone:hover { border-color: var(--teal-light); background: #f0f7f5; }
        .bulk-row-ok   { background: #f0fbf6; }
        .bulk-row-warn { background: #fffdf0; }
        .bulk-row-err  { background: #fff5f5; }
        .bulk-status-ok   { font-size:11px;font-weight:700;color:#0f7b6c; }
        .bulk-status-warn { font-size:11px;font-weight:700;color:#e67e22; }
        .bulk-status-err  { font-size:11px;font-weight:700;color:#e05263; }
        .bulk-warning-box { background:#fff8e0;border:1.5px solid #ffe082;border-radius:10px;padding:12px;font-size:12px;color:#7a5c00; }

        /* MISC */
        .empty-state { text-align: center; padding: 30px 20px; color: var(--muted); }
        .empty-state .empty-icon { font-size: 2.5em; margin-bottom: 10px; }
        .empty-state p { font-size: 13px; line-height: 1.5; }
        .section-label { font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin: 16px 0 10px; }
        .count-badge { display: inline-flex; align-items: center; justify-content: center; background: var(--teal); color: white; border-radius: 10px; font-size: 10px; font-weight: 800; padding: 2px 8px; margin-left: 8px; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: white; border-radius: 20px 20px 0 0; padding: 24px 20px 40px; width: 100%; max-width: 680px; max-height: 92vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px; }

        /* STAT */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 4px; }
        .stat-card { background: var(--bg); border-radius: 12px; padding: 14px; text-align: center; border: 1.5px solid var(--border); }
        .stat-num { font-family: 'Baloo 2', cursive; font-size: 2em; font-weight: 800; color: var(--teal); line-height: 1; }
        .stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; font-weight: 600; }
        .log-entry { background: var(--bg); border-radius: 10px; padding: 12px 14px; margin-bottom: 10px; border-left: 4px solid var(--teal); }
        .log-meta { font-size: 11px; color: var(--muted); font-weight: 600; margin-bottom: 4px; }
        .log-detail { font-size: 13px; font-weight: 500; }
        .log-qs { font-size: 11px; color: var(--teal); margin-top: 4px; font-weight: 600; }
        .backup-banner { background: linear-gradient(135deg,#fff8e7,#fef3cc); border: 1.5px solid var(--gold); border-radius: 12px; padding: 14px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
        .backup-icon { font-size: 1.8em; }
        .backup-text { flex: 1; }
        .backup-text strong { font-size: 13px; display: block; color: var(--ink); }
        .backup-text span { font-size: 11px; color: #8a7040; }
        .backup-btn { background: var(--gold); color: var(--ink); border: none; border-radius: 8px; padding: 8px 14px; font-weight: 700; font-size: 12px; cursor: pointer; font-family: 'DM Sans', sans-serif; white-space: nowrap; }
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--ink); color: white; padding: 12px 24px; border-radius: 30px; font-size: 13px; font-weight: 600; opacity: 0; transition: all 0.3s; z-index: 9999; white-space: nowrap; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .progress-bar-bg { background: var(--border); border-radius: 6px; height: 8px; overflow: hidden; }
        .progress-bar-fill { background: var(--teal); height: 8px; border-radius: 6px; transition: width 0.5s; }
        .progress-label { font-size: 11px; color: var(--muted); margin-top: 4px; font-weight: 600; }
        .q-list::-webkit-scrollbar, .nb-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .q-list::-webkit-scrollbar-thumb, .nb-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        #fileImport { display: none; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           SYLLABUS TRACKER STYLES (PHASE 5)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        /* Class selector row at top */
        .tracker-class-pills { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }

        /* FA filter row */
        .tracker-fa-pills { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 18px; }
        .fa-pill {
            padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
            cursor: pointer; border: 1.5px solid var(--border); background: white;
            color: var(--muted); transition: all 0.2s;
        }
        .fa-pill.active { background: var(--violet); color: white; border-color: var(--violet); }

        /* Overall class progress ring card */
        .tracker-overview {
            display: flex; align-items: center; gap: 20px;
            padding: 18px; background: linear-gradient(135deg, var(--ink), #2d2d4e);
            border-radius: 16px; margin-bottom: 16px; color: white;
        }
        .ring-wrap { position: relative; flex-shrink: 0; }
        .ring-svg { transform: rotate(-90deg); }
        .ring-bg  { fill: none; stroke: rgba(255,255,255,0.15); stroke-width: 8; }
        .ring-fill { fill: none; stroke: var(--gold); stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }
        .ring-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%,-50%);
            font-family: 'Baloo 2', cursive; font-size: 1.3em;
            font-weight: 800; color: white; text-align: center; line-height: 1;
        }
        .ring-text small { font-size: 0.5em; display: block; color: rgba(255,255,255,0.6); font-family: 'DM Sans',sans-serif; font-weight: 400; }
        .tracker-overview-info h3 { font-family: 'Baloo 2', cursive; font-size: 1.1em; font-weight: 800; }
        .tracker-overview-info p  { font-size: 12px; color: rgba(255,255,255,0.65); margin-top: 4px; line-height: 1.5; }
        .overview-chips { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .ov-chip { font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 10px; }
        .ov-chip-done    { background: rgba(46,204,113,0.2); color: #2ecc71; }
        .ov-chip-pending { background: rgba(245,166,35,0.2); color: var(--gold); }
        .ov-chip-locked  { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }

        /* Chapter accordion block */
        .chapter-block {
            background: var(--card); border-radius: 14px;
            border: 1.5px solid var(--border); margin-bottom: 12px;
            overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .chapter-block.all-done { border-color: #b2dfdb; }
        .chapter-block.in-progress { border-color: var(--gold); }
        .chapter-block.not-started { border-color: var(--border); opacity: 0.8; }

        .chapter-header {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 16px; cursor: pointer;
            transition: background 0.15s; user-select: none;
        }
        .chapter-header:hover { background: #f8fbfa; }

        .chapter-icon {
            width: 38px; height: 38px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1em; flex-shrink: 0;
        }
        .icon-done     { background: #e8f8f0; }
        .icon-progress { background: #fff8e0; }
        .icon-pending  { background: #f4f6f0; }

        .chapter-info { flex: 1; min-width: 0; }
        .chapter-name { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chapter-sub  { font-size: 11px; color: var(--muted); margin-top: 2px; }

        .chapter-pct {
            font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 1em;
            color: var(--teal); flex-shrink: 0;
        }
        .chapter-chevron { color: var(--muted); font-size: 14px; transition: transform 0.2s; flex-shrink: 0; }
        .chapter-block.open .chapter-chevron { transform: rotate(180deg); }

        /* Chapter mini progress bar */
        .chapter-bar-wrap { padding: 0 16px 14px; display: none; }
        .chapter-block.open .chapter-bar-wrap { display: block; }
        .ch-bar-bg   { background: var(--border); border-radius: 4px; height: 6px; overflow: hidden; margin-bottom: 14px; }
        .ch-bar-fill { height: 6px; border-radius: 4px; background: var(--teal); transition: width 0.5s; }

        /* Exercise rows inside chapter */
        .ex-row {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; border-radius: 10px;
            margin-bottom: 6px; border: 1.5px solid var(--border);
            background: #fafcfb; transition: all 0.15s;
        }
        .ex-row.done     { background: #f0fbf6; border-color: #b2dfdb; }
        .ex-row.in-prog  { background: #fffdf0; border-color: #ffe082; }
        .ex-row.pending  { background: var(--bg); }

        .ex-icon { font-size: 1.1em; flex-shrink: 0; }
        .ex-name { font-size: 13px; font-weight: 600; flex: 1; }
        .ex-detail { font-size: 11px; color: var(--muted); margin-top: 1px; }

        .ex-badge {
            font-size: 10px; font-weight: 700; padding: 3px 9px;
            border-radius: 10px; white-space: nowrap; flex-shrink: 0;
        }
        .badge-done    { background: #e8f8f0; color: #0f7b6c; }
        .badge-partial { background: #fff8e0; color: #b8860b; }
        .badge-pending { background: var(--bg); color: var(--muted); border: 1px solid var(--border); }

        /* Diary log mini entries inside chapter */
        .ex-logs { margin-top: 6px; padding-left: 12px; border-left: 3px solid var(--border); }
        .ex-log-row { font-size: 11px; color: var(--muted); padding: 3px 0; }
        .ex-log-row span { font-weight: 600; color: var(--ink); }

        /* Legend */
        .tracker-legend { display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 16px; }
        .legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; color: var(--muted); }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           ANALYTICS STYLES (PHASE 6)
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

        /* Selector bar */
        .an-selectors { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
        .an-selectors select { flex: 1; min-width: 120px; margin-top: 0; }

        /* KPI row */
        .kpi-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 4px; }
        .kpi-card { background: var(--bg); border-radius: 14px; padding: 14px 10px; text-align: center; border: 1.5px solid var(--border); }
        .kpi-num  { font-family: 'Baloo 2', cursive; font-size: 1.8em; font-weight: 800; line-height: 1; }
        .kpi-lbl  { font-size: 10px; font-weight: 700; color: var(--muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* SVG bar chart */
        .chart-wrap { width: 100%; overflow-x: auto; margin-top: 4px; }
        .chart-svg  { display: block; }
        .bar-rect   { transition: opacity 0.2s; cursor: default; }
        .bar-rect:hover { opacity: 0.8; }

        /* Horizontal grade dist bars */
        .h-bar-row   { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .h-bar-label { font-size: 12px; font-weight: 800; width: 28px; text-align: right; flex-shrink: 0; }
        .h-bar-track { flex: 1; background: var(--border); border-radius: 4px; height: 12px; overflow: hidden; }
        .h-bar-fill  { height: 12px; border-radius: 4px; transition: width 0.6s ease; }
        .h-bar-count { font-size: 11px; font-weight: 700; color: var(--muted); width: 22px; text-align: left; flex-shrink: 0; }

        /* Student performance table */
        .perf-table { width: 100%; border-collapse: collapse; }
        .perf-table th { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); padding: 8px 10px; text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
        .perf-table td { padding: 9px 10px; border-bottom: 1px solid #eef2f0; font-size: 13px; vertical-align: middle; }
        .perf-table tr:last-child td { border-bottom: none; }
        .perf-table tr:hover td { background: #f8fbfa; }
        .perf-rank { font-family: 'Baloo 2', cursive; font-weight: 800; color: var(--muted); font-size: 0.9em; }
        .perf-name { font-weight: 700; }
        .perf-sub  { font-size: 11px; color: var(--muted); }
        .perf-bar-wrap { width: 80px; }
        .perf-bar-bg   { background: var(--border); border-radius: 4px; height: 8px; overflow: hidden; }
        .perf-bar-fill { height: 8px; border-radius: 4px; }

        /* Spark line (inline SVG trend) */
        .spark { display: inline-block; vertical-align: middle; }

        /* Needs attention card */
        .attention-card { background: #fff5f5; border: 1.5px solid #fcc; border-radius: 12px; padding: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; }
        .attention-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 0.85em; color: white; flex-shrink: 0; }
        .attention-info   { flex: 1; }
        .attention-name   { font-weight: 700; font-size: 13px; }
        .attention-reason { font-size: 11px; color: var(--rose); margin-top: 2px; }
        .attention-score  { font-family: 'Baloo 2', cursive; font-weight: 800; font-size: 1.1em; color: var(--rose); flex-shrink: 0; }

        /* Trend arrow */
        .trend-up   { color: var(--teal); font-weight: 800; }
        .trend-down { color: var(--rose); font-weight: 800; }
        .trend-flat { color: var(--muted); font-weight: 800; }

        /* Section sub-heading */
        .section-head { font-family: 'Baloo 2', cursive; font-size: 0.95em; font-weight: 800; color: var(--ink); margin: 18px 0 10px; }

        /* No data state */
        .no-data { text-align: center; padding: 28px 16px; color: var(--muted); font-size: 13px; }
        .no-data .nd-icon { font-size: 2.2em; margin-bottom: 8px; }

    </style>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
</head>
<body>

<noscript><div style="padding:40px;text-align:center;font-family:sans-serif;color:#555;"><h2>JavaScript Required</h2><p>This app requires JavaScript to run. Please enable JavaScript in your browser settings.</p></div></noscript>

<!-- ‚ïê‚ïê‚ïê FIREBASE SETUP SCREEN (shown first time) ‚ïê‚ïê‚ïê -->
<div id="firebaseSetupScreen" style="display:none;position:fixed;inset:0;background:var(--ink);z-index:9999;overflow-y:auto;padding:30px 20px;">
    <div style="max-width:480px;margin:auto;">
        <div style="font-family:'Baloo 2',cursive;font-size:1.8em;font-weight:800;color:white;margin-bottom:6px;">üî• Connect to Cloud</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.6);margin-bottom:24px;line-height:1.6;">
            Paste your Firebase config below to enable automatic sync across all your devices. Your data will be saved to Google's cloud ‚Äî no more manual backups!
        </div>

        <!-- Step by step guide -->
        <div style="background:rgba(255,255,255,0.06);border-radius:14px;padding:18px;margin-bottom:20px;font-size:12px;color:rgba(255,255,255,0.75);line-height:2;">
            <div style="font-weight:700;color:var(--gold);margin-bottom:8px;font-size:13px;">üìã How to get your Firebase config:</div>
            <div>1. Go to <a href="https://console.firebase.google.com" target="_blank" style="color:var(--teal-light);">console.firebase.google.com</a></div>
            <div>2. Click <strong style="color:white;">"Add project"</strong> ‚Üí name it <em>teachersuite</em></div>
            <div>3. Disable Google Analytics ‚Üí <strong style="color:white;">Create project</strong></div>
            <div>4. Click <strong style="color:white;">"Web"</strong> icon (&lt;/&gt;) ‚Üí register app ‚Üí skip hosting</div>
            <div>5. Copy the <strong style="color:white;">firebaseConfig</strong> object shown</div>
            <div>6. Go to <strong style="color:white;">Firestore Database</strong> ‚Üí Create database ‚Üí <em>Start in test mode</em></div>
            <div>7. Paste the config below üëá</div>
        </div>

        <label style="color:rgba(255,255,255,0.5);font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:8px;">Paste your firebaseConfig here</label>
        <textarea id="fbConfigInput" rows="10" placeholder='{
  "apiKey": "AIza...",
  "authDomain": "your-app.firebaseapp.com",
  "projectId": "your-app-12345",
  "storageBucket": "your-app.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "1:123:web:abc"
}' style="width:100%;padding:14px;background:rgba(255,255,255,0.08);border:1.5px solid rgba(255,255,255,0.15);border-radius:12px;color:white;font-family:monospace;font-size:12px;line-height:1.7;resize:vertical;"></textarea>

        <button onclick="connectFirebase()" style="width:100%;margin-top:14px;padding:16px;background:var(--teal);border:none;border-radius:12px;color:white;font-family:'Baloo 2',cursive;font-size:1.1em;font-weight:700;cursor:pointer;">
            üî• Connect & Sync
        </button>
        <div id="fbSetupError" style="margin-top:12px;color:#ff7675;font-size:12px;text-align:center;display:none;"></div>

        <div style="margin-top:20px;text-align:center;">
            <button onclick="skipFirebase()" style="background:none;border:none;color:rgba(255,255,255,0.35);font-size:12px;cursor:pointer;text-decoration:underline;">
                Skip for now ‚Äî use local storage only
            </button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê SYNC STATUS INDICATOR ‚ïê‚ïê‚ïê -->
<div id="syncIndicator" style="display:none;position:fixed;bottom:16px;right:16px;z-index:5000;background:var(--ink);color:white;padding:8px 14px;border-radius:20px;font-size:11px;font-weight:700;align-items:center;gap:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);transition:all 0.3s;">
    <span id="syncDot" style="width:8px;height:8px;border-radius:50%;background:var(--gold);display:inline-block;"></span>
    <span id="syncText">Syncing‚Ä¶</span>
</div>

<!-- ‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê -->
<div id="loginScreen" style="display:none;position:fixed;inset:0;background:var(--ink);z-index:9998;display:none;align-items:center;justify-content:center;padding:20px;">
    <div style="max-width:360px;width:100%;text-align:center;">
        <div style="font-family:'Baloo 2',cursive;font-size:2em;font-weight:800;color:white;margin-bottom:8px;">Teacher<span style="color:var(--gold);">Suite</span> ‚ú¶</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:30px;">Sign in to sync your data across all devices</div>
        <button onclick="signInWithGoogle()" style="width:100%;padding:16px;background:white;border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-weight:700;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;">
            <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20H24v8h11.3C33.6 33.2 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.8 1.1 7.9 3l5.7-5.7C34.1 6.5 29.3 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c11 0 20-8.9 20-20 0-1.3-.1-2.7-.4-4z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.5 15.2 18.9 12 24 12c3 0 5.8 1.1 7.9 3l5.7-5.7C34.1 6.5 29.3 4 24 4 16.3 4 9.7 8.4 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.2 0 9.9-1.9 13.5-5.1l-6.2-5.2C29.5 35.5 26.9 36 24 36c-5.2 0-9.6-2.8-11.3-7l-6.6 4.8C9.7 39.6 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20H24v8h11.3c-.8 2.3-2.3 4.3-4.2 5.7l6.2 5.2C40.9 35.8 44 30.3 44 24c0-1.3-.1-2.7-.4-4z"/></svg>
            Sign in with Google
        </button>
        <div id="loginError" style="margin-top:12px;color:#ff7675;font-size:12px;display:none;"></div>
        <button onclick="skipFirebase()" style="margin-top:16px;background:none;border:none;color:rgba(255,255,255,0.35);font-size:12px;cursor:pointer;text-decoration:underline;">
            Skip ‚Äî use local storage only
        </button>
    </div>
</div>

<div class="header">
    <div class="header-top">
        <div class="app-title">Teacher<span>Suite</span> ‚ú¶</div>
        <div class="header-actions">
            <div id="userBadge" style="display:none;align-items:center;gap:8px;">
                <div id="userAvatar" style="width:28px;height:28px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;color:white;"></div>
            </div>
            <button class="hbtn hbtn-import" id="btnLocalImport" onclick="document.getElementById('fileImport').click()" style="display:none;">‚¨Ü Import</button>
            <button class="hbtn hbtn-export" id="btnLocalBackup" onclick="exportData()" style="display:none;">‚¨á Backup</button>
            <button class="hbtn" id="btnSignOut" onclick="signOut()" style="display:none;background:rgba(255,255,255,0.12);color:white;border:1px solid rgba(255,255,255,0.2);">Sign Out</button>
        </div>
    </div>
    <div class="tabs">
        <div class="tab active" onclick="showPage('students',this)">Students</div>
        <div class="tab" onclick="showPage('assign',this)">FA Map</div>
        <div class="tab" onclick="showPage('diary',this)">Diary</div>
        <div class="tab" onclick="showPage('notebook',this)">Notebooks</div>
        <div class="tab" onclick="showPage('tests',this)">Tests</div>
        <div class="tab" onclick="showPage('tracker',this)">Tracker</div>
        <div class="tab" onclick="showPage('analytics',this)">Analytics</div>
        <div class="tab" onclick="showPage('syllabi',this)">Syllabus</div>
        <div class="tab" onclick="showPage('dash',this)">Status</div>
    </div>
</div>

<input type="file" id="fileImport" accept=".json" onchange="importData(event)">
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê FA MAP ‚ïê‚ïê‚ïê -->
<div id="assign" class="page">
    <div class="backup-banner" id="backupBanner">
        <div class="backup-icon">üíæ</div>
        <div class="backup-text">
            <strong id="backupBannerTitle">Your data lives in this browser</strong>
            <span id="backupBannerSub">Tap "Backup" regularly ‚Äî one cache-clear can erase everything</span>
        </div>
        <button class="backup-btn" id="backupBannerBtn" onclick="exportData()">Backup Now</button>
    </div>
    <div class="card">
        <div class="card-title">üéØ FA Chapter Assignment</div>
        <label>Select Class</label><select id="assignClassSel" onchange="renderAssignment()"></select>
        <label>Select Assessment</label>
        <select id="assignFASel" onchange="renderAssignment()">
            <option>FA 1</option><option>FA 2</option><option>FA 3</option>
            <option>FA 4</option><option>FA 5</option><option>FA 6</option>
        </select>
        <div class="assign-box" id="assignmentList" style="margin-top:14px;"></div>
        <button class="btn btn-main" onclick="saveAssignment()">Save Assignment</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê DIARY ‚ïê‚ïê‚ïê -->
<div id="diary" class="page">
    <div class="card">
        <div class="card-title">‚úçÔ∏è Teacher's Diary</div>
        <label>Date</label><input type="date" id="diaryDate" onchange="updateTodayLogs()">
        <label>Class</label><select id="diaryClassSel" onchange="filterDiary()"></select>
        <label>Assessment</label>
        <select id="diaryFASel" onchange="filterDiary()">
            <option>FA 1</option><option>FA 2</option><option>FA 3</option>
            <option>FA 4</option><option>FA 5</option><option>FA 6</option>
        </select>
        <label>Chapter</label><select id="diaryChapSel" onchange="syncEx()"></select>
        <label>Exercise</label><select id="diaryExSel" onchange="loadQuestions()"></select>
        <label>Questions & Parts</label>
        <div class="q-list" id="qList"></div>
        <button class="btn btn-main" onclick="saveDiary()">üíæ Save to Diary</button>
        <button class="btn btn-wa" onclick="copyWhatsApp()">üì± Copy for WhatsApp</button>
    </div>
    <div class="card">
        <div class="card-title">üìÖ Today's Entries</div>
        <div id="todayLogs"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê STUDENTS ‚ïê‚ïê‚ïê -->
<div id="students" class="page active">
    <div class="card">
        <div class="card-title">‚ûï Add New Student</div>
        <div class="input-row">
            <div><label>First Name *</label><input type="text" id="sFirstName" placeholder="Ayesha"></div>
            <div><label>Last Name *</label><input type="text" id="sLastName" placeholder="Khan"></div>
        </div>
        <div class="input-row">
            <div><label>Roll Number *</label><input type="text" id="sRoll" placeholder="14"></div>
            <div><label>Class *</label><select id="sClass"></select></div>
        </div>
        <div class="input-row">
            <div><label>Section</label><input type="text" id="sSection" placeholder="A"></div>
            <div><label>Gender</label>
                <select id="sGender"><option value="">‚Äî Select ‚Äî</option><option value="Male">Male</option><option value="Female">Female</option></select>
            </div>
        </div>
        <label>Parent / Guardian Name</label><input type="text" id="sParent" placeholder="Mohammad Khan">
        <label>Parent Contact (WhatsApp)</label>
        <div style="display:grid;grid-template-columns:90px 1fr;gap:10px;">
            <div><label>Country Code</label><input type="text" id="sCountryCode" placeholder="+91" value="+91"></div>
            <div><label>Phone Number</label><input type="tel" id="sContact" placeholder="9876543210"></div>
        </div>
        <label>Remarks / Notes</label><input type="text" id="sRemarks" placeholder="Weak in fractions, attentive">
        <button class="btn btn-violet" onclick="addStudent()">Add Student to Profile</button>
    </div>

    <!-- ‚ïê‚ïê‚ïê BULK UPLOAD CARD ‚ïê‚ïê‚ïê -->
    <div class="card">
        <div class="card-title">üì§ Bulk Upload Students</div>
        <p style="font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:14px;">
            Upload a <strong>CSV</strong>, <strong>Excel (.xlsx)</strong>, or <strong>PDF</strong> file with your student list.
            The file must contain columns: <code style="background:#eef2f0;padding:2px 6px;border-radius:4px;font-size:11px;">Roll, First Name, Last Name, Class</code>
            (optional: Section, Gender, Parent, Contact, Remarks).
        </p>

        <!-- Format examples collapsible -->
        <div id="bulkFormatToggle" onclick="toggleBulkFormat()" style="cursor:pointer;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg);border-radius:10px;border:1.5px solid var(--border);margin-bottom:12px;">
            <span style="font-size:12px;font-weight:700;color:var(--teal);">üìã View accepted column names & sample</span>
            <span id="bulkFormatChevron" style="font-size:12px;color:var(--muted);">‚ñæ</span>
        </div>
        <div id="bulkFormatPanel" style="display:none;margin-bottom:14px;">
            <div style="background:#f8fbfa;border:1.5px solid var(--border);border-radius:10px;padding:12px;font-size:11px;font-family:monospace;overflow-x:auto;line-height:2;">
                <div style="color:var(--teal);font-weight:700;margin-bottom:6px;">Accepted column headers (case-insensitive):</div>
                <div><span style="color:var(--rose);">Roll / Roll No / Roll Number / Sr / Sr No</span></div>
                <div><span style="color:var(--violet);">First Name / FirstName / Name / Student Name</span></div>
                <div><span style="color:var(--violet);">Last Name / LastName / Surname</span></div>
                <div><span style="color:#2e86de;">Class / Grade / Std / Standard</span></div>
                <div><span style="color:var(--muted);">Section / Div / Division</span></div>
                <div><span style="color:var(--muted);">Gender / Sex</span></div>
                <div><span style="color:var(--muted);">Parent / Father / Guardian / Parent Name</span></div>
                <div><span style="color:var(--muted);">Contact / Phone / Mobile / WhatsApp</span></div>
                <div><span style="color:var(--muted);">Remarks / Notes / Comment</span></div>
                <div style="margin-top:10px;color:var(--muted);font-weight:700;">Sample CSV:</div>
                <div style="color:var(--ink);">Roll,First Name,Last Name,Class,Section,Gender,Contact</div>
                <div style="color:var(--ink);">1,Ayesha,Khan,Class 6,A,Female,9876543210</div>
                <div style="color:var(--ink);">2,Rahul,Sharma,Class 6,A,Male,</div>
            </div>
            <button class="btn btn-main" onclick="downloadSampleCSV()" style="margin-top:10px;padding:10px;font-size:0.85em;">‚¨á Download Sample CSV</button>
        </div>

        <!-- Drop zone -->
        <div id="bulkDropZone"
             ondrop="handleBulkDrop(event)" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')"
             onclick="document.getElementById('bulkFileInput').click()"
             style="border:2.5px dashed var(--border);border-radius:14px;padding:28px 20px;text-align:center;cursor:pointer;transition:all 0.2s;background:#fafcfb;margin-bottom:12px;">
            <div style="font-size:2.5em;margin-bottom:8px;">üìÅ</div>
            <div style="font-weight:700;font-size:14px;color:var(--ink);">Drop file here or tap to browse</div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">CSV ¬∑ Excel (.xlsx / .xls) ¬∑ PDF</div>
        </div>
        <input type="file" id="bulkFileInput" accept=".csv,.xlsx,.xls,.pdf" style="display:none" onchange="handleBulkFile(event)">

        <!-- Preview area -->
        <div id="bulkPreview" style="display:none;">
            <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;">Preview ‚Äî <span id="bulkPreviewCount"></span></div>
            <div style="overflow-x:auto;border-radius:10px;border:1.5px solid var(--border);max-height:280px;overflow-y:auto;">
                <table class="marks-table" id="bulkPreviewTable">
                    <thead><tr>
                        <th>Roll</th><th>First Name</th><th>Last Name</th><th>Class</th>
                        <th>Section</th><th>Gender</th><th>Contact</th><th>Status</th>
                    </tr></thead>
                    <tbody id="bulkPreviewBody"></tbody>
                </table>
            </div>
            <div id="bulkWarnings" style="margin-top:10px;"></div>
            <div style="display:flex;gap:10px;margin-top:12px;">
                <button class="btn btn-main" onclick="confirmBulkImport()" style="flex:1;margin-top:0;" id="bulkImportBtn">‚úÖ Import Valid Students</button>
                <button class="btn" onclick="cancelBulkImport()" style="flex:0 0 auto;width:auto;padding:14px 18px;margin-top:0;background:var(--bg);border:1.5px solid var(--border);">‚úï Cancel</button>
            </div>
        </div>
        <div id="bulkStatus" style="display:none;"></div>
    </div>
    <div class="card">
        <div class="card-title">üë• Student Profiles <span class="count-badge" id="studentCount">0</span></div>
        <div class="search-wrap">
            <span class="search-icon">üîç</span>
            <input type="text" id="studentSearch" placeholder="Search by name or roll number..." oninput="renderStudents()" style="padding-left:38px;">
        </div>
        <div class="pill-row" id="classPills"></div>
        <div id="studentGrid"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê NOTEBOOKS ‚ïê‚ïê‚ïê -->
<div id="notebook" class="page">
    <div class="card">
        <div class="card-title">üìì New Notebook Check</div>
        <div class="input-row">
            <div><label>Date</label><input type="date" id="nbDate"></div>
            <div><label>Class</label><select id="nbClass" onchange="loadNbStudents()"></select></div>
        </div>
        <label>Subject / Topic</label><input type="text" id="nbSubject" placeholder="e.g. Maths ‚Äì Chapter 3 Exercise">
        <label>Notebook Type</label>
        <select id="nbType">
            <option value="classwork">Classwork Notebook</option>
            <option value="homework">Homework Notebook</option>
            <option value="assignment">Assignment Book</option>
            <option value="rough">Rough Notebook</option>
            <option value="other">Other</option>
        </select>
        <button class="btn btn-orange" onclick="loadNbStudents()" style="margin-top:14px;">Load Students ‚Üì</button>
    </div>
    <div class="card" id="nbTableCard" style="display:none;">
        <div class="card-title">‚úÖ Mark Each Student</div>
        <div class="nb-summary" id="nbSummary"></div>
        <div class="nb-scroll" style="margin-top:14px;">
            <table class="nb-table">
                <thead><tr><th>Student</th><th>Status</th><th style="min-width:120px;">Remarks</th></tr></thead>
                <tbody id="nbTableBody"></tbody>
            </table>
        </div>
        <button class="btn btn-main" onclick="saveNbCheck()" style="margin-top:16px;">üíæ Save Notebook Record</button>
        <button class="btn btn-wa" onclick="copyNbWhatsApp()">üì± WhatsApp Report</button>
    </div>
    <div class="card">
        <div class="card-title">üìã Checking History <span class="count-badge" id="nbHistoryCount">0</span></div>
        <div class="pill-row" id="nbHistoryPills"></div>
        <div id="nbHistoryList"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TESTS PAGE (PHASE 4)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tests" class="page">

    <!-- Test Setup -->
    <div class="card">
        <div class="card-title">üìù Create New Test</div>
        <label>Test Name / Title</label>
        <input type="text" id="testName" placeholder="e.g. FA 2 ‚Äì Maths Unit Test">
        <div class="input-row">
            <div><label>Date</label><input type="date" id="testDate"></div>
            <div><label>Class</label><select id="testClass" onchange="loadTestStudents()"></select></div>
        </div>
        <div class="input-row">
            <div><label>Subject</label><input type="text" id="testSubject" placeholder="e.g. Mathematics"></div>
            <div><label>Total Marks</label><input type="number" id="testTotal" placeholder="e.g. 25" min="1" max="999" oninput="recalcGrades()"></div>
        </div>
        <div class="input-row">
            <div><label>Passing Marks</label><input type="number" id="testPass" placeholder="e.g. 10" min="0"></div>
            <div><label>FA / Assessment</label>
                <select id="testFA">
                    <option>FA 1</option><option>FA 2</option><option>FA 3</option>
                    <option>FA 4</option><option>FA 5</option><option>FA 6</option>
                    <option value="unit">Unit Test</option><option value="mid">Mid-Term</option>
                    <option value="final">Final Exam</option><option value="other">Other</option>
                </select>
            </div>
        </div>
        <label>Remarks / Notes about this test</label>
        <input type="text" id="testRemarks" placeholder="e.g. Open book, chapters 1‚Äì3">
        <button class="btn btn-blue" onclick="loadTestStudents()">Load Students & Enter Marks ‚Üì</button>
    </div>

    <!-- Marks Entry -->
    <div class="card" id="testEntryCard" style="display:none;">
        <div class="card-title">üìä Enter Marks</div>

        <!-- Live class analytics bar -->
        <div class="analytics-grid" id="testAnalytics"></div>

        <div class="nb-scroll" style="margin-top:16px;">
            <table class="marks-table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th style="text-align:center;">Marks</th>
                        <th style="text-align:center;">Grade</th>
                        <th style="text-align:center;">Absent</th>
                    </tr>
                </thead>
                <tbody id="marksTableBody"></tbody>
            </table>
        </div>

        <button class="btn btn-main" onclick="saveTest()" style="margin-top:16px;">üíæ Save Test Record</button>
        <button class="btn btn-wa" onclick="copyTestWhatsApp()">üì± WhatsApp Results</button>
    </div>

    <!-- Test History -->
    <div class="card">
        <div class="card-title">üìã Test History <span class="count-badge" id="testHistoryCount">0</span></div>
        <div class="pill-row" id="testHistoryPills"></div>
        <div id="testHistoryList"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SYLLABUS TRACKER (PHASE 5)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tracker" class="page">

    <!-- Class selector -->
    <div class="card">
        <div class="card-title">üìö Syllabus Tracker</div>

        <label>Select Class</label>
        <select id="trackerClass" onchange="renderTracker()"></select>

        <label style="margin-top:14px;">Filter by FA / Assessment</label>
        <div class="tracker-fa-pills" id="trackerFAPills"></div>

        <!-- Legend -->
        <div class="tracker-legend">
            <div class="legend-item"><div class="legend-dot" style="background:#2ecc71;"></div> Completed</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--gold);"></div> In Progress</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--border);"></div> Not Started</div>
        </div>
    </div>

    <!-- Overview ring + stats -->
    <div id="trackerOverview"></div>

    <!-- Chapter blocks -->
    <div id="trackerChapters"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ANALYTICS PAGE (PHASE 6)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="analytics" class="page">

    <!-- Selectors -->
    <div class="card">
        <div class="card-title">üìä Test Analytics</div>
        <div class="an-selectors">
            <select id="anClass" onchange="renderAnalytics()"></select>
            <select id="anTest"  onchange="renderAnalytics()">
                <option value="all">‚Äî All Tests ‚Äî</option>
            </select>
        </div>
    </div>

    <!-- KPI Cards -->
    <div id="anKPI"></div>

    <!-- Score Distribution Bar Chart -->
    <div class="card" id="anChartCard" style="display:none;">
        <div class="card-title">üìà Score Distribution</div>
        <div class="chart-wrap" id="anChart"></div>
    </div>

    <!-- Grade Distribution -->
    <div class="card" id="anGradeCard" style="display:none;">
        <div class="card-title">üèÖ Grade Breakdown</div>
        <div id="anGradeDist"></div>
    </div>

    <!-- Test-over-time trend (when class selected, all tests) -->
    <div class="card" id="anTrendCard" style="display:none;">
        <div class="card-title">üìâ Class Average Trend</div>
        <div class="chart-wrap" id="anTrend"></div>
    </div>

    <!-- Student performance leaderboard -->
    <div class="card" id="anLeaderCard" style="display:none;">
        <div class="card-title">üèÜ Student Performance</div>
        <div id="anLeaderboard"></div>
    </div>

    <!-- Needs Attention -->
    <div class="card" id="anAttentionCard" style="display:none;">
        <div class="card-title">‚ö†Ô∏è Needs Attention</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:12px;">Students scoring below 40% or consistently declining.</p>
        <div id="anAttention"></div>
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê SYLLABUS ‚ïê‚ïê‚ïê -->
<div id="syllabi" class="page">
    <div class="card">
        <div class="card-title">‚öôÔ∏è Syllabus Configuration</div>
        <p style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.5;">Format: <code style="background:#eee;padding:2px 5px;border-radius:4px;font-size:11px;">Ch 1: Name | Ex 1.1: questions: parts</code></p>
        <select id="configClassSel" onchange="loadConfigText()"></select>
        <textarea id="configText" rows="16" style="font-family:monospace;font-size:12px;margin-top:10px;line-height:1.8;"></textarea>
        <button class="btn btn-main" onclick="saveSyllabus()">Update Syllabus</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê STATUS ‚ïê‚ïê‚ïê -->
<div id="dash" class="page">
    <div class="card">
        <div class="card-title">üìä Question Coverage</div>
        <div class="stat-grid" id="statGrid"></div>
    </div>
    <div class="card">
        <div class="card-title">üìà Syllabus Progress</div>
        <div id="progressContent"></div>
    </div>
    <div class="card">
        <div class="card-title">üìì Notebook Summary</div>
        <div id="nbStatusContent"></div>
    </div>
    <div class="card">
        <div class="card-title">üèÜ Test Performance</div>
        <div id="testStatusContent"></div>
    </div>
    <div class="card">
        <div class="card-title">üìã Recent Diary Entries</div>
        <div id="recentLogs"></div>
    </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="studentModal" onclick="closeStudentModal(event)">
    <div class="modal"><div class="modal-handle"></div><div id="studentModalContent"></div></div>
</div>
<div class="modal-overlay" id="nbDetailModal" onclick="closeNbModal(event)">
    <div class="modal"><div class="modal-handle"></div><div id="nbDetailContent"></div></div>
</div>
<div class="modal-overlay" id="testDetailModal" onclick="closeTestModal(event)">
    <div class="modal"><div class="modal-handle"></div><div id="testDetailContent"></div></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AVATAR_COLORS = ['#0f7b6c','#7c5cbf','#e05263','#f5a623','#2e86de','#26c281','#e74c3c','#8e44ad','#2980b9','#d35400'];
function avatarColor(n) { let h=0; for(let c of n) h=(h*31+c.charCodeAt(0))%AVATAR_COLORS.length; return AVATAR_COLORS[h]; }
// Unified initials helper ‚Äî works with first+last OR a full name string
function initials(f, l) {
    if (l === undefined) {
        // Called with a single full-name string
        const parts = (f||'').trim().split(' ');
        return ((parts[0]?.[0]||'') + (parts[1]?.[0]||'')).toUpperCase();
    }
    return ((f[0]||'')+(l[0]||'')).toUpperCase();
}
// Alias kept for analytics code that used the old two-arg name
function initials2(name) { return initials(name); }

// XSS-safe HTML escape ‚Äî use on ALL user-supplied text injected into innerHTML
function esc(str) {
    return String(str ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
}

// Build a WhatsApp link from stored contact + country code
function waLink(s) {
    if (!s.contact) return null;
    const cc = (s.countryCode || '+91').replace(/\D/g,''); // strip non-digits
    const num = s.contact.replace(/\D/g,'');
    return `https://wa.me/${cc}${num}`;
}

// Timezone-safe "today" date string (local date, not UTC)
function localToday() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
}

// Grade scale (out of percentage)
function calcGrade(marks, total) {
    if (total === 0) return 'X';
    const pct = (marks / total) * 100;
    if (pct >= 90) return 'A+';
    if (pct >= 75) return 'A';
    if (pct >= 60) return 'B';
    if (pct >= 45) return 'C';
    if (pct >= 33) return 'D';
    return 'F';
}
function gradeClass(g) {
    if (g.startsWith('A')) return 'grade-A';
    if (g === 'B') return 'grade-B';
    if (g === 'C') return 'grade-C';
    if (g === 'D') return 'grade-D';
    if (g === 'F') return 'grade-F';
    return 'grade-X';
}

// ‚îÄ‚îÄ‚îÄ DATABASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CURRICULUM_DATA = {
    "Class 5": "Ch 1: Large Numbers | Ex 1.1: 10: 0, Ex 1.2: 8: 4\nCh 2: Operations | Ex 2.1: 12: 0, Ex 2.2: 6: 2\nCh 3: Factors & Multiples | Ex 3.1: 15: 0\nCh 4: Fractions | Ex 4.1: 10: 3",
    "Class 6": "Ch 1: Knowing Numbers | Ex 1.1: 4: 5, Ex 1.2: 12: 0\nCh 2: Whole Numbers | Ex 2.1: 8: 1, Ex 2.2: 7: 0\nCh 3: Playing with Numbers | Ex 3.1: 4: 9, Ex 3.2: 12: 0\nCh 4: Basic Geometry | Ex 4.1: 6: 4",
    "Class 7": "Ch 1: Integers | Ex 1.1: 10: 0, Ex 1.2: 4: 2\nCh 2: Fractions & Decimals | Ex 2.1: 8: 5, Ex 2.2: 15: 0\nCh 3: Data Handling | Ex 3.1: 9: 0",
    "Class 8": "Ch 1: Rational Numbers | Ex 1.1: 11: 0"
};

let db = JSON.parse(localStorage.getItem('teachersuite_v4')) || {
    syllabus: CURRICULUM_DATA, assignments: {}, logs: [],
    students: [], nbChecks: [], tests: []
};
if (!db.students) db.students = [];
if (!db.nbChecks) db.nbChecks = [];
if (!db.tests)    db.tests    = [];

// ‚îÄ‚îÄ‚îÄ FIREBASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Stored in localStorage so user only enters once
let firebaseMode = false;  // true = cloud, false = local
let firestoreDB  = null;
let currentUser  = null;
let syncTimeout  = null;

const FB_CONFIG_KEY   = 'teachersuite_fb_config';
const FB_SKIPPED_KEY  = 'teachersuite_fb_skipped';

// ‚îÄ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Always saves locally. If Firebase connected, also syncs to cloud.
function saveDB() {
    localStorage.setItem('teachersuite_v4', JSON.stringify(db));
    if (firebaseMode && currentUser) {
        schedulCloudSync();
    }
}

// Debounced cloud sync ‚Äî batches rapid saves into one write
function schedulCloudSync() {
    clearTimeout(syncTimeout);
    showSyncIndicator('syncing');
    syncTimeout = setTimeout(() => pushToCloud(), 1200);
}

async function pushToCloud() {
    try {
        const uid = currentUser.uid;
        await firestoreDB.collection('users').doc(uid).set({
            data: JSON.stringify(db),
            updatedAt: new Date().toISOString(),
            deviceInfo: navigator.userAgent.slice(0,80)
        });
        showSyncIndicator('saved');
    } catch(e) {
        console.error('Cloud sync failed:', e);
        showSyncIndicator('error');
    }
}

async function pullFromCloud() {
    try {
        showSyncIndicator('syncing');
        const uid  = currentUser.uid;
        const doc  = await firestoreDB.collection('users').doc(uid).get();
        if (doc.exists && doc.data().data) {
            const cloudData = JSON.parse(doc.data().data);
            const localData = JSON.parse(localStorage.getItem('teachersuite_v4') || '{}');
            // Merge students by id ‚Äî keep all unique students from both
            const allStudents = [...(cloudData.students || [])];
            (localData.students || []).forEach(s => {
                if (!allStudents.find(cs => cs.id === s.id)) allStudents.push(s);
            });
            cloudData.students = allStudents;
            db = cloudData;
            if (!db.students) db.students = [];
            if (!db.nbChecks) db.nbChecks = [];
            if (!db.tests)    db.tests    = [];
            localStorage.setItem('teachersuite_v4', JSON.stringify(db));
            refreshAllUI();
            showSyncIndicator('saved');
            toast('‚òÅÔ∏è Data loaded from cloud!');
        } else {
            // No cloud data yet ‚Äî push local data up
            await pushToCloud();
            toast('‚òÅÔ∏è Local data backed up to cloud!');
        }
    } catch(e) {
        console.error('Pull from cloud failed:', e);
        showSyncIndicator('error');
        toast('‚ö†Ô∏è Could not reach cloud. Working offline.');
    }
}

function showSyncIndicator(state) {
    const ind  = document.getElementById('syncIndicator');
    const dot  = document.getElementById('syncDot');
    const text = document.getElementById('syncText');
    if (!firebaseMode) { ind.style.display = 'none'; return; }
    ind.style.display = 'flex';
    if (state === 'syncing') { dot.style.background = 'var(--gold)'; text.textContent = 'Syncing‚Ä¶'; }
    if (state === 'saved')   { dot.style.background = 'var(--success)'; text.textContent = 'Saved to cloud ‚úì';
        setTimeout(() => { ind.style.display = 'none'; }, 3000); }
    if (state === 'error')   { dot.style.background = 'var(--rose)'; text.textContent = 'Sync failed ‚Äî saved locally'; }
    if (state === 'offline') { dot.style.background = 'var(--muted)'; text.textContent = 'Offline ‚Äî saved locally'; }
}

// ‚îÄ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initFirebase() {
    const config = {
        apiKey: "AIzaSyBZI5p5lkqrkONPSWrZTyBzxoohfe9gPuE",
        authDomain: "teachersuite-588f1.firebaseapp.com",
        projectId: "teachersuite-588f1",
        storageBucket: "teachersuite-588f1.firebasestorage.app",
        messagingSenderId: "120718320779",
        appId: "1:120718320779:web:514f0e626261dd5f3da08e"
    };
    localStorage.setItem(FB_CONFIG_KEY, JSON.stringify(config));
    startFirebaseApp(config);
}
function startFirebaseApp(config) {
    try {
        if (!firebase.apps.length) firebase.initializeApp(config);
        firestoreDB = firebase.firestore();
        const auth  = firebase.auth();

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser  = user;
                firebaseMode = true;
                onUserSignedIn(user);
            } else {
                // Show Google sign-in
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('loginScreen').style.display = 'flex';
            }
        });
    } catch(e) {
        console.error('Firebase init failed:', e);
        toast('‚ö†Ô∏è Firebase config error ‚Äî using local mode');
        startLocalMode();
    }
}

function onUserSignedIn(user) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('firebaseSetupScreen').style.display = 'none';

    // Show user avatar in header
    const badge  = document.getElementById('userBadge');
    const avatar = document.getElementById('userAvatar');
    badge.style.display = 'flex';
    avatar.textContent  = (user.displayName || user.email || 'U')[0].toUpperCase();
    avatar.title        = user.displayName || user.email;
    document.getElementById('btnSignOut').style.display = 'block';

    // Update backup banner ‚Üí cloud mode
    document.getElementById('backupBannerTitle').textContent = '‚òÅÔ∏è Cloud Sync Active';
    document.getElementById('backupBannerSub').textContent   = `Signed in as ${user.displayName || user.email} ‚Äî data syncs automatically`;
    document.getElementById('backupBannerBtn').textContent   = 'Sync Now';
    document.getElementById('backupBannerBtn').onclick       = () => pullFromCloud();
    // Hide after 5 seconds in cloud mode
    setTimeout(() => { document.getElementById('backupBanner').style.display = 'none'; }, 5000);

    // Pull latest data from cloud
    pullFromCloud().then(() => {
        startApp();
    });
}

function startLocalMode() {
    firebaseMode = false;
    document.getElementById('btnLocalImport').style.display = 'block';
    document.getElementById('btnLocalBackup').style.display = 'block';
    document.getElementById('firebaseSetupScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'none';
    startApp();
}

function startApp() {
    populateClassSelects();
    ['diaryDate','nbDate','testDate'].forEach(id => document.getElementById(id).value = localToday());
    renderAssignment(); loadConfigText(); filterDiary(); updateTodayLogs();
    renderStudents(); buildClassPills(); renderNbHistory(); renderTestHistory();
    renderTracker(); renderAnalytics();
    if (!firebaseMode) updateBackupBanner();
}

function refreshAllUI() {
    populateClassSelects();
    renderAssignment(); loadConfigText(); filterDiary(); updateTodayLogs();
    renderStudents(); buildClassPills(); renderNbHistory(); renderTestHistory();
    renderTracker(); renderAnalytics();
}

// ‚îÄ‚îÄ‚îÄ FIREBASE UI ACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectFirebase() {
    const raw = document.getElementById('fbConfigInput').value.trim();
    const errEl = document.getElementById('fbSetupError');
    errEl.style.display = 'none';

    let config;
    try {
        // Strategy 1: extract just the {...} object block
        const objMatch = raw.match(/\{[\s\S]*\}/);
        if (!objMatch) throw new Error('No object found');
        let objStr = objMatch[0];

        // Strategy 2: try direct JSON parse first
        try {
            config = JSON.parse(objStr);
        } catch(e1) {
            // Strategy 3: convert JS object literal to JSON
            // Handle unquoted keys, single quotes, trailing commas
            let jsonStr = objStr
                .replace(/\/\/.*$/gm, '')                    // remove comments
                .replace(/,\s*([}\]])/g, '$1')               // trailing commas
                .replace(/([{,]\s*)([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":') // unquoted keys
                .replace(/:\s*'([^']*)'/g, ': "$1"');        // single ‚Üí double quotes
            config = JSON.parse(jsonStr);
        }
    } catch(e) {
        errEl.textContent = '‚ùå Could not read config. Try: In Firebase ‚Üí Project Settings ‚Üí SDK setup ‚Üí click "Config" ‚Üí copy just the { } block';
        errEl.style.display = 'block';
        return;
    }

    if (!config.apiKey || !config.projectId) {
        errEl.textContent = '‚ùå Missing apiKey or projectId. Please check your config.';
        errEl.style.display = 'block';
        return;
    }

    localStorage.setItem(FB_CONFIG_KEY, JSON.stringify(config));
    localStorage.removeItem(FB_SKIPPED_KEY);
    startFirebaseApp(config);
}

function skipFirebase() {
    localStorage.setItem(FB_SKIPPED_KEY, '1');
    startLocalMode();
}

async function signInWithGoogle() {
    try {
        document.getElementById('loginError').style.display = 'none';
        const provider = new firebase.auth.GoogleAuthProvider();
        await firebase.auth().signInWithPopup(provider);
        // onAuthStateChanged will handle the rest
    } catch(e) {
        const el = document.getElementById('loginError');
        el.textContent = '‚ùå Sign in failed: ' + e.message;
        el.style.display = 'block';
    }
}

async function signOut() {
    if (!confirm('Sign out? You can sign back in anytime.')) return;
    await firebase.auth().signOut();
    localStorage.removeItem(FB_CONFIG_KEY);
    localStorage.removeItem(FB_SKIPPED_KEY);
    location.reload();
}

// Online/offline detection
window.addEventListener('online',  () => { if (firebaseMode) { pushToCloud(); } });
window.addEventListener('offline', () => { showSyncIndicator('offline'); });


// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeClassFilter = 'All';
let nbHistoryFilter   = 'All';
let testHistoryFilter = 'All';
let testMarksState    = {}; // { studentId: { marks: number|null, absent: bool } }

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = () => { initFirebase(); };

function populateClassSelects() {
    ['assignClassSel','diaryClassSel','configClassSel','sClass','nbClass','testClass','trackerClass','anClass'].forEach(id => {
        const sel = document.getElementById(id); sel.innerHTML = '';
        Object.keys(db.syllabus).forEach(c => sel.add(new Option(c,c)));
    });
}
function saveDB() { localStorage.setItem('teachersuite_v4', JSON.stringify(db)); }
function toast(msg,dur=2500) {
    const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),dur);
}

// ‚îÄ‚îÄ‚îÄ PAGE SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id,el) {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(id).classList.add('active'); el.classList.add('active');
    if(id==='diary')     { filterDiary(); updateTodayLogs(); }
    if(id==='dash')      renderStatus();
    if(id==='students')  { renderStudents(); buildClassPills(); }
    if(id==='notebook')  renderNbHistory();
    if(id==='tests')     renderTestHistory();
    if(id==='tracker')   renderTracker();
    if(id==='analytics') renderAnalytics();
}

// ‚îÄ‚îÄ‚îÄ EXPORT / IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportData() {
    const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`teachersuite_backup_${localToday()}.json`;
    a.click();
    localStorage.setItem('teachersuite_last_backup', localToday());
    updateBackupBanner();
    toast('‚úÖ Backup downloaded!');
}

function updateBackupBanner() {
    const banner = document.getElementById('backupBanner');
    if (!banner) return;
    const lastBackup = localStorage.getItem('teachersuite_last_backup');
    if (lastBackup) {
        const daysSince = Math.floor((new Date(localToday()) - new Date(lastBackup)) / 86400000);
        if (daysSince < 3) { banner.style.display = 'none'; return; }
        banner.querySelector('.backup-text span').textContent = `Last backup: ${daysSince} day${daysSince>1?'s':''} ago. Tap to back up now.`;
    }
    banner.style.display = 'flex';
}
function importData(event) {
    const file=event.target.files[0]; if(!file) return;
    // Warn user if there is existing data that would be overwritten
    const hasData = db.students.length > 0 || db.logs.length > 0 || db.tests.length > 0 || db.nbChecks.length > 0;
    if (hasData && !confirm('‚ö†Ô∏è Importing will REPLACE all your current data with the backup file.\n\nThis cannot be undone. Continue?')) {
        event.target.value = '';
        return;
    }
    const reader=new FileReader();
    reader.onload=(e)=>{
        try {
            const imp=JSON.parse(e.target.result);
            if(!imp.logs||!imp.syllabus) throw new Error();
            if(!imp.students) imp.students=[];
            if(!imp.nbChecks) imp.nbChecks=[];
            if(!imp.tests)    imp.tests=[];
            db=imp; saveDB(); populateClassSelects();
            renderAssignment(); filterDiary(); loadConfigText();
            renderStudents(); buildClassPills(); renderNbHistory(); renderTestHistory();
            renderTracker(); renderAnalytics();
            if (firebaseMode && currentUser) pushToCloud();
            toast('‚úÖ Data imported!');
        } catch { toast('‚ùå Invalid backup file'); }
    };
    reader.readAsText(file); event.target.value='';
}

// ‚îÄ‚îÄ‚îÄ FA ASSIGNMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAssignment() {
    const cls=document.getElementById('assignClassSel').value;
    const fa=document.getElementById('assignFASel').value;
    const container=document.getElementById('assignmentList'); container.innerHTML='';
    if(!db.syllabus[cls]) return;
    const chapters=db.syllabus[cls].split('\n').map(l=>l.split('|')[0].trim()).filter(Boolean);
    const current=(db.assignments[cls]?.[fa])||[];
    chapters.forEach(ch=>{
        const div=document.createElement('div'); div.className='assign-row';
        div.innerHTML=`<input type="checkbox" value="${ch}" ${current.includes(ch)?'checked':''}><span>${ch}</span>`;
        div.onclick=(e)=>{ if(e.target.tagName!=='INPUT') div.querySelector('input').click(); };
        container.appendChild(div);
    });
}
function saveAssignment() {
    const cls=document.getElementById('assignClassSel').value;
    const fa=document.getElementById('assignFASel').value;
    if(!db.assignments[cls]) db.assignments[cls]={};
    db.assignments[cls][fa]=Array.from(document.querySelectorAll('#assignmentList input:checked')).map(i=>i.value);
    saveDB(); toast('‚úÖ Assignment saved!');
}

// ‚îÄ‚îÄ‚îÄ DIARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterDiary() {
    const cls=document.getElementById('diaryClassSel').value;
    const fa=document.getElementById('diaryFASel').value;
    const chapSel=document.getElementById('diaryChapSel'); chapSel.innerHTML='';
    const assigned=db.assignments[cls]?.[fa]||[];
    if(assigned.length===0){
        chapSel.add(new Option('-- No Chapters Assigned --',''));
        document.getElementById('diaryExSel').innerHTML=''; document.getElementById('qList').innerHTML=''; return;
    }
    db.syllabus[cls].split('\n').forEach(line=>{ const name=line.split('|')[0].trim(); if(assigned.includes(name)) chapSel.add(new Option(name,line)); });
    syncEx();
}
function syncEx() {
    const line=document.getElementById('diaryChapSel').value;
    const exSel=document.getElementById('diaryExSel'); exSel.innerHTML='';
    if(!line||!line.includes('|')) return;
    line.split('|')[1].split(',').forEach(part=>exSel.add(new Option(part.split(':')[0].trim(),part.trim())));
    loadQuestions();
}
function loadQuestions() {
    const data=document.getElementById('diaryExSel').value; if(!data) return;
    const parts=data.split(':').map(s=>s.trim());
    const qty=parseInt(parts[1]); const subParts=parseInt(parts[2])||0;
    const container=document.getElementById('qList'); container.innerHTML='';
    for(let i=1;i<=qty;i++){
        if(subParts>1) for(let j=0;j<subParts;j++) createQRow(container,`Q${i}(${String.fromCharCode(97+j)})`);
        else createQRow(container,`Q${i}`);
    }
}
function createQRow(parent,label){
    const div=document.createElement('div'); div.className='q-row';
    div.innerHTML=`<input type="checkbox" value="${label}"><span class="q-label">${label}</span>
        <select class="type-select"><option value="mcq">MCQ</option><option value="fill">Fill-In</option><option value="vsa">V-Short</option><option value="short" selected>Short</option><option value="long">Long</option></select>`;
    parent.appendChild(div);
}
function saveDiary() {
    const checked=Array.from(document.querySelectorAll('#qList input:checked'));
    if(checked.length===0){toast('‚ö†Ô∏è Select at least one question');return;}
    db.logs.push({date:document.getElementById('diaryDate').value,fa:document.getElementById('diaryFASel').value,
        cls:document.getElementById('diaryClassSel').value,chap:document.getElementById('diaryChapSel').selectedOptions[0]?.text||'',
        ex:document.getElementById('diaryExSel').value.split(':')[0].trim(),
        qs:checked.map(i=>({id:i.value,type:i.closest('.q-row').querySelector('.type-select').value}))});
    saveDB(); updateTodayLogs(); toast('‚úÖ Diary entry saved!');
}
function updateTodayLogs() {
    const today=document.getElementById('diaryDate').value;
    const entries=db.logs.filter(l=>l.date===today);
    const el=document.getElementById('todayLogs');
    el.innerHTML=entries.length===0?'<p style="color:var(--muted);font-size:13px;">No entries for this date yet.</p>'
        :entries.map(e=>`<div class="log-entry"><div class="log-meta">${e.cls} ¬∑ ${e.fa}</div><div class="log-detail">üìç ${e.chap} ‚Äî ${e.ex}</div><div class="log-qs">Questions: ${e.qs.map(q=>q.id).join(', ')}</div></div>`).join('');
}
function copyWhatsApp() {
    const date=document.getElementById('diaryDate').value;
    const entries=db.logs.filter(l=>l.date===date);
    if(entries.length===0){toast('‚ö†Ô∏è No entries to copy');return;}
    let msg=`üìù *DIARY ‚Äî ${date}*\n\n`;
    entries.forEach(e=>{msg+=`*${e.cls} (${e.fa})*\nüìç ${e.chap} ‚Äî ${e.ex}\nüîπ ${e.qs.map(q=>`${q.id} (${q.type})`).join(', ')}\n\n`;});
    navigator.clipboard.writeText(msg).then(()=>toast('üìã Copied!'));
}

// ‚îÄ‚îÄ‚îÄ SYLLABUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadConfigText(){document.getElementById('configText').value=db.syllabus[document.getElementById('configClassSel').value]||'';}
function saveSyllabus(){
    const raw = document.getElementById('configText').value.trim();
    const cls = document.getElementById('configClassSel').value;
    // Validate format
    const lines = raw.split('\n').filter(Boolean);
    const errors = [];
    lines.forEach((line, i) => {
        if (!line.includes('|')) {
            if (!line.startsWith('Ch ')) errors.push(`Line ${i+1}: Chapter line should start with "Ch X: Name"`);
            return;
        }
        const parts = line.split('|');
        if (!parts[0].trim()) { errors.push(`Line ${i+1}: Missing chapter name before "|"`); return; }
        const exParts = parts[1].split(',');
        exParts.forEach(ep => {
            const p = ep.trim().split(':');
            if (p.length < 2 || isNaN(parseInt(p[1]))) {
                errors.push(`Line ${i+1}: Exercise "${ep.trim()}" ‚Äî format should be "Ex X.Y: questions: parts"`);
            }
        });
    });
    if (errors.length > 0) {
        alert('‚ö†Ô∏è Syllabus format errors found:\n\n' + errors.slice(0,5).join('\n') + (errors.length>5?`\n‚Ä¶and ${errors.length-5} more`:''));
        return;
    }
    db.syllabus[cls] = raw;
    saveDB(); populateClassSelects(); renderTracker(); toast('‚úÖ Syllabus updated!');
}

// ‚îÄ‚îÄ‚îÄ STUDENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addStudent(){
    const first=document.getElementById('sFirstName').value.trim();
    const last=document.getElementById('sLastName').value.trim();
    const roll=document.getElementById('sRoll').value.trim();
    const cls=document.getElementById('sClass').value;
    if(!first||!last||!roll){toast('‚ö†Ô∏è Name and Roll Number required');return;}
    if(db.students.find(s=>s.roll===roll&&s.cls===cls)){toast(`‚ö†Ô∏è Roll ${roll} already in ${cls}`);return;}
    db.students.push({id:Date.now().toString(),first,last,roll,cls,
        section:document.getElementById('sSection').value.trim(),gender:document.getElementById('sGender').value,
        parent:document.getElementById('sParent').value.trim(),contact:document.getElementById('sContact').value.trim(),
        countryCode:document.getElementById('sCountryCode').value.trim()||'+91',
        remarks:document.getElementById('sRemarks').value.trim(),addedOn:new Date().toISOString().slice(0,10)});
    saveDB();
    ['sFirstName','sLastName','sRoll','sSection','sParent','sContact','sRemarks'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('sCountryCode').value='+91';
    document.getElementById('sGender').value='';
    renderStudents(); buildClassPills(); toast(`‚úÖ ${first} ${last} added!`);
}
function deleteStudent(id,event){
    event.stopPropagation();
    if(!confirm('Delete this student profile?')) return;
    db.students=db.students.filter(s=>s.id!==id);
    saveDB(); renderStudents(); buildClassPills(); toast('üóëÔ∏è Student removed');
}
function buildClassPills(){
    const classes=['All',...Object.keys(db.syllabus)];
    document.getElementById('classPills').innerHTML=classes.map(c=>`<div class="pill ${activeClassFilter===c?'active':''}" onclick="setClassFilter('${c}')">${c}</div>`).join('');
}
function setClassFilter(cls){activeClassFilter=cls;buildClassPills();renderStudents();}
function renderStudents(){
    const search=(document.getElementById('studentSearch')?.value||'').toLowerCase();
    let students=[...db.students];
    if(activeClassFilter!=='All') students=students.filter(s=>s.cls===activeClassFilter);
    if(search) students=students.filter(s=>`${s.first} ${s.last}`.toLowerCase().includes(search)||s.roll.toLowerCase().includes(search));
    students.sort((a,b)=>a.cls!==b.cls?a.cls.localeCompare(b.cls):parseInt(a.roll)-parseInt(b.roll));
    document.getElementById('studentCount').textContent=db.students.length;
    const grid=document.getElementById('studentGrid');
    if(students.length===0){grid.innerHTML=`<div class="empty-state"><div class="empty-icon">üë§</div><p>${db.students.length===0?'No students added yet.':'No students match your search.'}</p></div>`;return;}
    const grouped={};
    students.forEach(s=>{if(!grouped[s.cls]) grouped[s.cls]=[];grouped[s.cls].push(s);});
    grid.innerHTML='';
    Object.keys(grouped).sort().forEach(cls=>{
        if(activeClassFilter==='All'){const l=document.createElement('div');l.className='section-label';l.textContent=`${cls} (${grouped[cls].length} students)`;grid.appendChild(l);}
        const g=document.createElement('div');g.className='student-grid';
        grouped[cls].forEach(s=>{
            const color=avatarColor(s.first+s.last);
            const card=document.createElement('div');card.className='student-card';card.onclick=()=>openStudentModal(s.id);
            card.innerHTML=`<button class="student-delete" onclick="deleteStudent('${esc(s.id)}',event)" title="Remove">‚úï</button>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                    <div class="student-avatar" style="background:${color};">${initials(s.first,s.last)}</div>
                    <div><div class="student-name">${esc(s.first)} ${esc(s.last)}</div><div class="student-meta">Roll ${esc(s.roll)}${s.section?' ¬∑ Sec '+esc(s.section):''}</div></div>
                </div>
                ${s.gender?`<span class="student-badge">${esc(s.gender)}</span>`:''}
                ${s.contact?`<span class="student-badge" style="background:var(--violet);margin-left:4px;">üìû</span>`:''}
                ${s.remarks?`<div style="font-size:11px;color:var(--muted);margin-top:6px;line-height:1.4;font-style:italic;">"${esc(s.remarks.slice(0,40))}${s.remarks.length>40?'‚Ä¶':''}"</div>`:''}`;
            g.appendChild(card);
        });
        grid.appendChild(g);
    });
}
function openStudentModal(id){
    const s=db.students.find(st=>st.id===id);if(!s) return;
    const color=avatarColor(s.first+s.last);

    // Collect test history for this student
    const testHistory=db.tests.filter(t=>t.cls===s.cls)
        .map(t=>{ const r=t.results.find(r=>r.studentId===s.id); return r?{name:t.name,date:t.date,marks:r.marks,total:t.total,absent:r.absent}:null; })
        .filter(Boolean);

    document.getElementById('studentModalContent').innerHTML=`
        <div class="student-detail-header">
            <div class="student-detail-avatar" style="background:${color};">${initials(s.first,s.last)}</div>
            <div class="student-detail-info"><h3>${esc(s.first)} ${esc(s.last)}</h3><p>${esc(s.cls)}${s.section?' ¬∑ Section '+esc(s.section):''} ¬∑ Roll No. ${esc(s.roll)}</p></div>
        </div>
        ${s.gender?`<div class="info-row"><span class="info-key">Gender</span><span class="info-val">${esc(s.gender)}</span></div>`:''}
        ${s.parent?`<div class="info-row"><span class="info-key">Parent</span><span class="info-val">${esc(s.parent)}</span></div>`:''}
        ${s.contact?`<div class="info-row"><span class="info-key">Contact</span><span class="info-val"><a href="${esc(waLink(s))}" style="color:var(--teal);text-decoration:none;">üì± ${esc(s.contact)}</a></span></div>`:''}
        ${s.remarks?`<div class="info-row"><span class="info-key">Remarks</span><span class="info-val" style="color:var(--muted);font-style:italic;">${esc(s.remarks)}</span></div>`:''}
        <div class="info-row"><span class="info-key">Added On</span><span class="info-val">${esc(s.addedOn)}</span></div>
        ${testHistory.length>0?`
        <div style="margin-top:16px;padding-top:12px;border-top:2px solid var(--border);">
            <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;">üìä Test Performance</div>
            ${testHistory.map(t=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eef2f0;font-size:13px;">
                <span>${esc(t.name)}</span>
                <span style="font-weight:700;color:${t.absent?'var(--muted)':parseInt(t.marks)<parseInt(t.total)*0.33?'var(--rose)':'var(--teal)'};">
                    ${t.absent?'Absent':`${esc(String(t.marks))}/${esc(String(t.total))} (${calcGrade(t.marks,t.total)})`}
                </span>
            </div>`).join('')}
        </div>`:''}
        <div style="margin-top:16px;padding-top:12px;border-top:2px solid var(--border);">
            ${s.contact?`<button class="btn btn-wa" style="margin-top:0;" onclick="window.open('${esc(waLink(s))}','_blank')">üì± WhatsApp Parent</button>`:''}
            <button class="btn btn-blue" onclick="openEditStudent('${esc(s.id)}')" style="margin-top:10px;">‚úèÔ∏è Edit Student</button>
            <button class="btn btn-rose" onclick="deleteStudent('${esc(s.id)}',event);closeModal('studentModal');">üóëÔ∏è Remove Student</button>
        </div>`;
    document.getElementById('studentModal').classList.add('open');
}
function openEditStudent(id) {
    const s = db.students.find(st => st.id === id); if (!s) return;
    // Replace modal content with edit form
    document.getElementById('studentModalContent').innerHTML = `
        <div style="font-family:'Baloo 2',cursive;font-size:1.1em;font-weight:800;margin-bottom:16px;color:var(--teal);">‚úèÔ∏è Edit Student</div>
        <div class="input-row">
            <div><label>First Name</label><input type="text" id="editFirst" value="${esc(s.first)}"></div>
            <div><label>Last Name</label><input type="text" id="editLast" value="${esc(s.last)}"></div>
        </div>
        <div class="input-row">
            <div><label>Roll Number</label><input type="text" id="editRoll" value="${esc(s.roll)}"></div>
            <div><label>Class</label><select id="editClass">${Object.keys(db.syllabus).map(c=>`<option${c===s.cls?' selected':''}>${esc(c)}</option>`).join('')}</select></div>
        </div>
        <div class="input-row">
            <div><label>Section</label><input type="text" id="editSection" value="${esc(s.section||'')}"></div>
            <div><label>Gender</label>
                <select id="editGender">
                    <option value="">‚Äî Select ‚Äî</option>
                    <option value="Male"${s.gender==='Male'?' selected':''}>Male</option>
                    <option value="Female"${s.gender==='Female'?' selected':''}>Female</option>
                </select>
            </div>
        </div>
        <label>Parent / Guardian Name</label><input type="text" id="editParent" value="${esc(s.parent||'')}">
        <div style="display:grid;grid-template-columns:90px 1fr;gap:10px;margin-top:14px;">
            <div><label>Country Code</label><input type="text" id="editCC" value="${esc(s.countryCode||'+91')}"></div>
            <div><label>Phone</label><input type="tel" id="editContact" value="${esc(s.contact||'')}"></div>
        </div>
        <label>Remarks / Notes</label><input type="text" id="editRemarks" value="${esc(s.remarks||'')}">
        <button class="btn btn-main" onclick="saveEditStudent('${esc(s.id)}')" style="margin-top:16px;">üíæ Save Changes</button>
        <button class="btn" onclick="openStudentModal('${esc(s.id)}')" style="background:var(--bg);border:1.5px solid var(--border);margin-top:8px;">‚Üê Cancel</button>`;
}

function saveEditStudent(id) {
    const s = db.students.find(st => st.id === id); if (!s) return;
    const newFirst = document.getElementById('editFirst').value.trim();
    const newLast  = document.getElementById('editLast').value.trim();
    const newRoll  = document.getElementById('editRoll').value.trim();
    const newCls   = document.getElementById('editClass').value;
    if (!newFirst || !newLast || !newRoll) { toast('‚ö†Ô∏è Name and Roll Number are required'); return; }
    // Check for roll collision (exclude self)
    if (db.students.find(st => st.id !== id && st.roll === newRoll && st.cls === newCls)) {
        toast(`‚ö†Ô∏è Roll ${newRoll} already exists in ${newCls}`); return;
    }
    s.first       = newFirst;
    s.last        = newLast;
    s.roll        = newRoll;
    s.cls         = newCls;
    s.section     = document.getElementById('editSection').value.trim();
    s.gender      = document.getElementById('editGender').value;
    s.parent      = document.getElementById('editParent').value.trim();
    s.countryCode = document.getElementById('editCC').value.trim() || '+91';
    s.contact     = document.getElementById('editContact').value.trim();
    s.remarks     = document.getElementById('editRemarks').value.trim();
    saveDB();
    renderStudents(); buildClassPills();
    openStudentModal(id); // reopen view mode
    toast(`‚úÖ ${newFirst} ${newLast} updated!`);
}

function closeModal(id){ document.getElementById(id||'studentModal').classList.remove('open'); }
function closeNbModal(event){if(!event||event.target===document.getElementById('nbDetailModal')) document.getElementById('nbDetailModal').classList.remove('open');}
function closeTestModal(event) {
    if (!event || event.target === document.getElementById('testDetailModal'))
        document.getElementById('testDetailModal').classList.remove('open');
}
// ‚îÄ‚îÄ‚îÄ NOTEBOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let nbState={};
function loadNbStudents(){
    const cls=document.getElementById('nbClass').value;
    const students=db.students.filter(s=>s.cls===cls).sort((a,b)=>parseInt(a.roll)-parseInt(b.roll));
    if(students.length===0){toast(`‚ö†Ô∏è No students in ${cls}`);document.getElementById('nbTableCard').style.display='none';return;}
    nbState={};
    students.forEach(s=>{nbState[s.id]={status:'',remarks:''};});
    const tbody=document.getElementById('nbTableBody'); tbody.innerHTML='';
    students.forEach(s=>{
        const color=avatarColor(s.first+s.last);
        const tr=document.createElement('tr'); tr.id=`nbrow-${s.id}`;
        tr.innerHTML=`<td><div class="nb-student-info"><div class="nb-avatar" style="background:${color};">${initials(s.first,s.last)}</div><div><div class="nb-name">${s.first} ${s.last}</div><div class="nb-roll">Roll ${s.roll}</div></div></div></td>
            <td><div class="status-btns"><button class="status-btn" onclick="setNbStatus('${s.id}','submitted',this)">‚úÖ Done</button><button class="status-btn" onclick="setNbStatus('${s.id}','incomplete',this)">‚ö†Ô∏è Partial</button><button class="status-btn" onclick="setNbStatus('${s.id}','missing',this)">‚ùå Missing</button></div></td>
            <td><input class="nb-remarks-input" type="text" placeholder="Optional note‚Ä¶" oninput="nbState['${s.id}'].remarks=this.value"></td>`;
        tbody.appendChild(tr);
    });
    document.getElementById('nbTableCard').style.display='block';
    updateNbSummary();
    document.getElementById('nbTableCard').scrollIntoView({behavior:'smooth',block:'start'});
}
function setNbStatus(sid,status,btn){
    nbState[sid].status=status;
    const row=document.getElementById(`nbrow-${sid}`);
    row.querySelectorAll('.status-btn').forEach(b=>{b.className='status-btn';});
    btn.classList.add(`active-${status}`);
    updateNbSummary();
}
function updateNbSummary(){
    const vals=Object.values(nbState);
    const s=vals.filter(v=>v.status==='submitted').length;
    const i=vals.filter(v=>v.status==='incomplete').length;
    const m=vals.filter(v=>v.status==='missing').length;
    document.getElementById('nbSummary').innerHTML=`
        <div class="nb-sum-pill nb-sum-total"><div class="nb-sum-num">${vals.length}</div><div class="nb-sum-label">Total</div></div>
        <div class="nb-sum-pill nb-sum-submitted"><div class="nb-sum-num">${s}</div><div class="nb-sum-label">Submitted</div></div>
        <div class="nb-sum-pill nb-sum-incomplete"><div class="nb-sum-num">${i}</div><div class="nb-sum-label">Partial</div></div>
        <div class="nb-sum-pill nb-sum-missing"><div class="nb-sum-num">${m}</div><div class="nb-sum-label">Missing</div></div>`;
}
function saveNbCheck(){
    const cls=document.getElementById('nbClass').value;
    const subject=document.getElementById('nbSubject').value.trim();
    if(!subject){toast('‚ö†Ô∏è Enter a subject/topic');return;}
    if(!Object.values(nbState).some(v=>v.status!=='')){toast('‚ö†Ô∏è Mark at least one student');return;}
    const records=[];
    Object.entries(nbState).forEach(([sid,val])=>{
        if(val.status){const s=db.students.find(s=>s.id===sid);if(s) records.push({studentId:sid,name:`${s.first} ${s.last}`,roll:s.roll,status:val.status,remarks:val.remarks});}
    });
    db.nbChecks.push({id:Date.now().toString(),date:document.getElementById('nbDate').value,cls,subject,type:document.getElementById('nbType').value,records});
    saveDB(); nbState={}; document.getElementById('nbTableCard').style.display='none'; document.getElementById('nbSubject').value='';
    renderNbHistory(); toast('‚úÖ Notebook record saved!');
}
function copyNbWhatsApp(){
    const cls=document.getElementById('nbClass').value;
    const date=document.getElementById('nbDate').value;
    const subject=document.getElementById('nbSubject').value.trim()||'Notebook Check';
    const submitted=[],incomplete=[],missing=[];
    Object.entries(nbState).forEach(([sid,val])=>{
        if(!val.status) return;
        const s=db.students.find(st=>st.id===sid); if(!s) return;
        const name=`${s.first} ${s.last} (Roll ${s.roll})`;
        if(val.status==='submitted') submitted.push(name);
        if(val.status==='incomplete') incomplete.push(name);
        if(val.status==='missing') missing.push(name);
    });
    let msg=`üìì *NOTEBOOK CHECK ‚Äî ${date}*\n*${cls} | ${subject}*\n\n`;
    if(submitted.length)  msg+=`‚úÖ *Submitted (${submitted.length}):*\n${submitted.join('\n')}\n\n`;
    if(incomplete.length) msg+=`‚ö†Ô∏è *Partial (${incomplete.length}):*\n${incomplete.join('\n')}\n\n`;
    if(missing.length)    msg+=`‚ùå *Not Submitted (${missing.length}):*\n${missing.join('\n')}\n\n`;
    navigator.clipboard.writeText(msg).then(()=>toast('üìã Report copied!'));
}
function renderNbHistory(){
    const allClasses=['All',...Object.keys(db.syllabus)];
    document.getElementById('nbHistoryPills').innerHTML=allClasses.map(c=>`<div class="pill ${nbHistoryFilter===c?'active':''}" onclick="setNbFilter('${c}')">${c}</div>`).join('');
    let checks=[...db.nbChecks].reverse();
    if(nbHistoryFilter!=='All') checks=checks.filter(c=>c.cls===nbHistoryFilter);
    document.getElementById('nbHistoryCount').textContent=db.nbChecks.length;
    const container=document.getElementById('nbHistoryList');
    if(checks.length===0){container.innerHTML=`<div class="empty-state"><div class="empty-icon">üìì</div><p>No notebook checks recorded yet.</p></div>`;return;}
    container.innerHTML=checks.map(c=>{
        const s=c.records.filter(r=>r.status==='submitted').length;
        const i=c.records.filter(r=>r.status==='incomplete').length;
        const m=c.records.filter(r=>r.status==='missing').length;
        const tl={classwork:'Classwork',homework:'Homework',assignment:'Assignment',rough:'Rough Book',other:'Other'}[c.type]||c.type;
        return `<div class="nb-history-entry" onclick="openNbDetail('${esc(c.id)}')">
            <div class="nb-history-meta">${esc(c.date)} ¬∑ ${esc(c.cls)} ¬∑ ${esc(tl)}</div>
            <div class="nb-history-title">üìù ${esc(c.subject)}</div>
            <div class="nb-history-stats">
                <span class="nb-stat-chip chip-submitted">‚úÖ ${s} Done</span>
                <span class="nb-stat-chip chip-incomplete">‚ö†Ô∏è ${i} Partial</span>
                <span class="nb-stat-chip chip-missing">‚ùå ${m} Missing</span>
            </div></div>`;
    }).join('');
}
function setNbFilter(cls){nbHistoryFilter=cls;renderNbHistory();}
function openNbDetail(checkId){
    const c=db.nbChecks.find(ch=>ch.id===checkId);if(!c) return;
    const submitted=c.records.filter(r=>r.status==='submitted');
    const incomplete=c.records.filter(r=>r.status==='incomplete');
    const missing=c.records.filter(r=>r.status==='missing');
    const tl={classwork:'Classwork',homework:'Homework',assignment:'Assignment',rough:'Rough Book',other:'Other'}[c.type]||c.type;
    const listS=(arr)=>arr.map(r=>`<div style="display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid #eef2f0;font-size:13px;"><span>${esc(r.name)} <span style="color:var(--muted);font-size:11px;">Roll ${esc(r.roll)}</span></span>${r.remarks?`<span style="color:var(--muted);font-size:11px;font-style:italic;">${esc(r.remarks)}</span>`:''}</div>`).join('');
    document.getElementById('nbDetailContent').innerHTML=`
        <div style="margin-bottom:16px;"><div style="font-size:12px;color:var(--muted);font-weight:700;">${esc(c.date)} ¬∑ ${esc(c.cls)} ¬∑ ${esc(tl)}</div>
        <div style="font-family:'Baloo 2',cursive;font-size:1.2em;font-weight:800;margin-top:4px;">${esc(c.subject)}</div></div>
        <div class="nb-summary" style="margin-bottom:20px;">
            <div class="nb-sum-pill nb-sum-submitted"><div class="nb-sum-num">${submitted.length}</div><div class="nb-sum-label">Done</div></div>
            <div class="nb-sum-pill nb-sum-incomplete"><div class="nb-sum-num">${incomplete.length}</div><div class="nb-sum-label">Partial</div></div>
            <div class="nb-sum-pill nb-sum-missing"><div class="nb-sum-num">${missing.length}</div><div class="nb-sum-label">Missing</div></div>
        </div>
        ${submitted.length?`<div style="font-size:11px;font-weight:700;color:#0f7b6c;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;">‚úÖ Submitted</div>${listS(submitted)}`:''}
        ${incomplete.length?`<div style="font-size:11px;font-weight:700;color:#e67e22;text-transform:uppercase;letter-spacing:.8px;margin:12px 0 6px;">‚ö†Ô∏è Partial</div>${listS(incomplete)}`:''}
        ${missing.length?`<div style="font-size:11px;font-weight:700;color:#e05263;text-transform:uppercase;letter-spacing:.8px;margin:12px 0 6px;">‚ùå Not Submitted</div>${listS(missing)}`:''}
        <button class="btn btn-rose" onclick="deleteNbCheck('${c.id}')" style="margin-top:20px;font-size:0.85em;padding:10px;">üóëÔ∏è Delete This Record</button>`;
    document.getElementById('nbDetailModal').classList.add('open');
}
function deleteNbCheck(id){if(!confirm('Delete this notebook record?')) return;db.nbChecks=db.nbChecks.filter(c=>c.id!==id);saveDB();closeNbModal();renderNbHistory();toast('üóëÔ∏è Record deleted');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TEST RECORDS  (PHASE 4)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadTestStudents() {
    const name    = document.getElementById('testName').value.trim();
    const cls     = document.getElementById('testClass').value;
    const subject = document.getElementById('testSubject').value.trim();
    const total   = parseInt(document.getElementById('testTotal').value);

    if (!name)              { toast('‚ö†Ô∏è Enter a test name');      return; }
    if (!subject)           { toast('‚ö†Ô∏è Enter a subject');        return; }
    if (!total || total<1)  { toast('‚ö†Ô∏è Enter valid total marks');return; }

    const students = db.students.filter(s=>s.cls===cls).sort((a,b)=>parseInt(a.roll)-parseInt(b.roll));
    if (students.length===0) { toast(`‚ö†Ô∏è No students in ${cls}. Add students first.`); return; }

    // Init state
    testMarksState = {};
    students.forEach(s => { testMarksState[s.id] = { marks: '', absent: false }; });

    const tbody = document.getElementById('marksTableBody');
    tbody.innerHTML = '';

    students.forEach(s => {
        const color = avatarColor(s.first + s.last);
        const tr    = document.createElement('tr'); tr.id = `testrow-${s.id}`;
        tr.innerHTML = `
            <td>
                <div class="nb-student-info">
                    <div class="nb-avatar" style="background:${color};">${initials(s.first,s.last)}</div>
                    <div><div class="nb-name">${s.first} ${s.last}</div><div class="nb-roll">Roll ${s.roll}</div></div>
                </div>
            </td>
            <td style="text-align:center;">
                <input class="marks-input" type="number" id="marks-${s.id}" min="0" max="${total}"
                    placeholder="‚Äî" oninput="onMarksInput('${s.id}',this)">
            </td>
            <td style="text-align:center;">
                <div class="grade-badge grade-X" id="grade-${s.id}">‚Äî</div>
            </td>
            <td style="text-align:center;">
                <button class="absent-toggle" id="absent-${s.id}" onclick="toggleAbsent('${s.id}')">Absent</button>
            </td>`;
        tbody.appendChild(tr);
    });

    document.getElementById('testEntryCard').style.display = 'block';
    updateTestAnalytics();
    document.getElementById('testEntryCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function onMarksInput(sid, input) {
    const total = parseInt(document.getElementById('testTotal').value) || 0;
    let val     = parseFloat(input.value);

    // Clamp
    if (val > total) { val = total; input.value = total; }
    if (val < 0)     { val = 0; input.value = 0; }

    testMarksState[sid].marks = input.value === '' ? '' : val;

    // Update grade badge
    const gradeBadge = document.getElementById(`grade-${sid}`);
    if (input.value === '' || testMarksState[sid].absent) {
        gradeBadge.textContent = '‚Äî'; gradeBadge.className = 'grade-badge grade-X';
    } else {
        const g = calcGrade(val, total);
        gradeBadge.textContent = g;
        gradeBadge.className   = `grade-badge ${gradeClass(g)}`;
    }

    updateTestAnalytics();
}

function toggleAbsent(sid) {
    const state  = testMarksState[sid];
    state.absent = !state.absent;
    const btn    = document.getElementById(`absent-${sid}`);
    const inp    = document.getElementById(`marks-${sid}`);
    const badge  = document.getElementById(`grade-${sid}`);

    if (state.absent) {
        btn.classList.add('marked');
        inp.disabled = true; inp.value = '';
        state.marks  = '';
        badge.textContent = 'AB'; badge.className = 'grade-badge grade-X';
    } else {
        btn.classList.remove('marked');
        inp.disabled = false;
        badge.textContent = '‚Äî'; badge.className = 'grade-badge grade-X';
    }
    updateTestAnalytics();
}

function updateTestAnalytics() {
    const total = parseInt(document.getElementById('testTotal').value) || 0;
    const pass  = parseInt(document.getElementById('testPass').value)  || 0;
    const vals  = Object.values(testMarksState).filter(v => !v.absent && v.marks !== '').map(v => parseFloat(v.marks));
    const absent= Object.values(testMarksState).filter(v => v.absent).length;

    const avg    = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) : '‚Äî';
    const highest= vals.length ? Math.max(...vals) : '‚Äî';
    const lowest = vals.length ? Math.min(...vals) : '‚Äî';
    const passed = pass ? vals.filter(v=>v>=pass).length : '‚Äî';

    document.getElementById('testAnalytics').innerHTML = `
        <div class="an-card"><div class="an-num" style="color:var(--teal);">${avg}</div><div class="an-label">Class Avg</div></div>
        <div class="an-card"><div class="an-num" style="color:var(--success);">${highest}</div><div class="an-label">Highest</div></div>
        <div class="an-card"><div class="an-num" style="color:var(--rose);">${lowest}</div><div class="an-label">Lowest</div></div>
        <div class="an-card"><div class="an-num" style="color:var(--violet);">${passed}</div><div class="an-label">Passed</div></div>
        <div class="an-card"><div class="an-num" style="color:var(--muted);">${absent}</div><div class="an-label">Absent</div></div>
        <div class="an-card"><div class="an-num" style="color:var(--ink);">${vals.length}</div><div class="an-label">Marked</div></div>`;
}

function recalcGrades() {
    const total = parseInt(document.getElementById('testTotal').value) || 0;
    Object.keys(testMarksState).forEach(sid => {
        if (testMarksState[sid].absent) return;
        const inp   = document.getElementById(`marks-${sid}`);
        const badge = document.getElementById(`grade-${sid}`);
        if (!inp || !badge) return;
        const val = parseFloat(inp.value);
        if (!isNaN(val) && inp.value !== '') {
            const g = calcGrade(val, total);
            badge.textContent = g; badge.className = `grade-badge ${gradeClass(g)}`;
        }
    });
    updateTestAnalytics();
}

function saveTest() {
    const name    = document.getElementById('testName').value.trim();
    const cls     = document.getElementById('testClass').value;
    const date    = document.getElementById('testDate').value;
    const subject = document.getElementById('testSubject').value.trim();
    const total   = parseInt(document.getElementById('testTotal').value);
    const pass    = parseInt(document.getElementById('testPass').value) || 0;
    const fa      = document.getElementById('testFA').value;
    const remarks = document.getElementById('testRemarks').value.trim();

    const hasAny = Object.values(testMarksState).some(v => v.absent || v.marks !== '');
    if (!hasAny) { toast('‚ö†Ô∏è Enter marks for at least one student'); return; }

    // Build results
    const results = [];
    Object.entries(testMarksState).forEach(([sid, val]) => {
        const s = db.students.find(s => s.id === sid); if (!s) return;
        results.push({
            studentId: sid, name: `${s.first} ${s.last}`, roll: s.roll,
            marks: val.absent ? null : (val.marks === '' ? null : parseFloat(val.marks)),
            absent: val.absent,
            grade: val.absent ? 'AB' : (val.marks !== '' ? calcGrade(parseFloat(val.marks), total) : '‚Äî')
        });
    });

    db.tests.push({ id: Date.now().toString(), name, cls, date, subject, total, pass, fa, remarks, results });
    saveDB();

    // Reset
    testMarksState = {};
    document.getElementById('testEntryCard').style.display = 'none';
    document.getElementById('testName').value   = '';
    document.getElementById('testSubject').value= '';
    document.getElementById('testTotal').value  = '';
    document.getElementById('testPass').value   = '';
    document.getElementById('testRemarks').value= '';
    renderTestHistory();
    toast('‚úÖ Test record saved!');
}

function copyTestWhatsApp() {
    const name    = document.getElementById('testName').value.trim()    || 'Test';
    const cls     = document.getElementById('testClass').value;
    const date    = document.getElementById('testDate').value;
    const total   = parseInt(document.getElementById('testTotal').value) || 0;
    const pass    = parseInt(document.getElementById('testPass').value)  || 0;

    const rows = Object.entries(testMarksState)
        .map(([sid, val]) => {
            const s = db.students.find(s => s.id === sid); if (!s) return null;
            return { name: `${s.first} ${s.last}`, roll: s.roll, marks: val.marks, absent: val.absent };
        })
        .filter(Boolean)
        .sort((a,b) => {
            // Absent students go to bottom; otherwise sort by marks descending
            if (a.absent && !b.absent) return 1;
            if (!a.absent && b.absent) return -1;
            return parseFloat(b.marks||0) - parseFloat(a.marks||0);
        });

    const passStudents = rows.filter(r => !r.absent && parseFloat(r.marks) >= pass);
    const failStudents = rows.filter(r => !r.absent && (r.marks==='' || parseFloat(r.marks) < pass));
    const absentS      = rows.filter(r => r.absent);

    let msg = `üìù *${name}*\n*${cls} | ${date} | Out of ${total}*\n\n`;
    if (pass) msg += `üéØ Passing Marks: ${pass}\n\n`;

    const markedVals = rows.filter(r=>!r.absent&&r.marks!=='').map(r=>parseFloat(r.marks));
    if (markedVals.length) {
        const avg = (markedVals.reduce((a,b)=>a+b,0)/markedVals.length).toFixed(1);
        msg += `üìä Class Avg: ${avg} | Highest: ${Math.max(...markedVals)} | Lowest: ${Math.min(...markedVals)}\n\n`;
    }
    if (pass && passStudents.length) msg += `‚úÖ *Passed (${passStudents.length}):*\n${passStudents.map(r=>`${r.name} ‚Äì ${r.marks}/${total} (${calcGrade(r.marks,total)})`).join('\n')}\n\n`;
    if (pass && failStudents.length) msg += `‚ùå *Needs Improvement (${failStudents.length}):*\n${failStudents.map(r=>`${r.name} ‚Äì ${r.marks===''?'Not marked':r.marks+'/'+total}`).join('\n')}\n\n`;
    if (absentS.length)              msg += `‚ö†Ô∏è *Absent (${absentS.length}):*\n${absentS.map(r=>r.name).join('\n')}\n\n`;

    navigator.clipboard.writeText(msg).then(() => toast('üìã Results copied!'));
}

// ‚îÄ‚îÄ‚îÄ TEST HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTestHistory() {
    const allClasses = ['All', ...Object.keys(db.syllabus)];
    document.getElementById('testHistoryPills').innerHTML = allClasses.map(c =>
        `<div class="pill ${testHistoryFilter===c?'active':''}" onclick="setTestFilter('${c}')">${c}</div>`).join('');

    let tests = [...db.tests].reverse();
    if (testHistoryFilter !== 'All') tests = tests.filter(t => t.cls === testHistoryFilter);
    document.getElementById('testHistoryCount').textContent = db.tests.length;

    const container = document.getElementById('testHistoryList');
    if (tests.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìù</div><p>No tests recorded yet.<br>Create a test above and enter marks.</p></div>`;
        return;
    }

    container.innerHTML = tests.map(t => {
        const markedResults = t.results.filter(r => !r.absent && r.marks !== null);
        const avg     = markedResults.length ? (markedResults.reduce((a,r)=>a+r.marks,0)/markedResults.length).toFixed(1) : null;
        const highest = markedResults.length ? Math.max(...markedResults.map(r=>r.marks)) : null;
        const passed  = t.pass ? markedResults.filter(r=>r.marks>=t.pass).length : null;
        const absent  = t.results.filter(r=>r.absent).length;

        return `<div class="test-history-card" onclick="openTestDetail('${esc(t.id)}')">
            <div class="test-history-meta">${esc(t.date)} ¬∑ ${esc(t.cls)} ¬∑ ${esc(t.fa)} ¬∑ Out of ${esc(String(t.total))}</div>
            <div class="test-history-title">üìù ${esc(t.name)}</div>
            <div class="test-chips">
                ${avg!==null ? `<span class="test-chip chip-avg">Avg ${avg}</span>` : ''}
                ${highest!==null ? `<span class="test-chip chip-top">Top ${highest}</span>` : ''}
                ${passed!==null ? `<span class="test-chip chip-pass">${passed} Passed</span>` : ''}
                ${absent ? `<span class="test-chip chip-missing">${absent} Absent</span>` : ''}
            </div>
        </div>`;
    }).join('');
}

function setTestFilter(cls) { testHistoryFilter = cls; renderTestHistory(); }

function openTestDetail(testId) {
    const t = db.tests.find(ts => ts.id === testId); if (!t) return;

    const sorted = [...t.results].sort((a,b) => {
        if (a.absent && !b.absent) return 1;
        if (!a.absent && b.absent) return -1;
        return (b.marks??-1) - (a.marks??-1);
    });

    const markedR  = sorted.filter(r => !r.absent && r.marks !== null);
    const avg      = markedR.length ? (markedR.reduce((a,r)=>a+r.marks,0)/markedR.length).toFixed(1) : null;
    const highest  = markedR.length ? Math.max(...markedR.map(r=>r.marks)) : null;
    const lowest   = markedR.length ? Math.min(...markedR.map(r=>r.marks)) : null;
    const absentC  = sorted.filter(r=>r.absent).length;
    const passedC  = t.pass ? markedR.filter(r=>r.marks>=t.pass).length : null;

    // Grade distribution
    const gradeCounts = { 'A+':0, A:0, B:0, C:0, D:0, F:0 };
    markedR.forEach(r => { const g=calcGrade(r.marks,t.total); if(gradeCounts[g]!==undefined) gradeCounts[g]++; });
    const gradeColors  = { 'A+':'#0f7b6c', A:'#13a88f', B:'#2e86de', C:'#f5a623', D:'#e67e22', F:'#e05263' };

    function gradeDist() {
        return Object.entries(gradeCounts).map(([g,cnt]) => {
            const pct = markedR.length ? Math.round((cnt/markedR.length)*100) : 0;
            return `<div class="grade-bar-row">
                <div class="grade-bar-label" style="color:${gradeColors[g]};">${g}</div>
                <div class="grade-bar-bg"><div class="grade-bar-fill" style="width:${pct}%;background:${gradeColors[g]};"></div></div>
                <div class="grade-bar-count">${cnt}</div>
            </div>`;
        }).join('');
    }

    document.getElementById('testDetailContent').innerHTML = `
        <div style="margin-bottom:16px;">
            <div style="font-size:12px;color:var(--muted);font-weight:700;">${esc(t.date)} ¬∑ ${esc(t.cls)} ¬∑ ${esc(t.fa)} ¬∑ Out of ${esc(String(t.total))}</div>
            <div style="font-family:'Baloo 2',cursive;font-size:1.2em;font-weight:800;margin-top:4px;">${esc(t.name)}</div>
            ${t.subject?`<div style="font-size:12px;color:var(--muted);margin-top:2px;">${esc(t.subject)}</div>`:''}
            ${t.remarks?`<div style="font-size:12px;color:var(--muted);font-style:italic;margin-top:2px;">${esc(t.remarks)}</div>`:''}
        </div>

        <!-- Analytics -->
        <div class="analytics-grid" style="margin-bottom:16px;">
            <div class="an-card"><div class="an-num">${avg??'‚Äî'}</div><div class="an-label">Class Avg</div></div>
            <div class="an-card"><div class="an-num" style="color:var(--success);">${highest??'‚Äî'}</div><div class="an-label">Highest</div></div>
            <div class="an-card"><div class="an-num" style="color:var(--rose);">${lowest??'‚Äî'}</div><div class="an-label">Lowest</div></div>
            ${passedC!==null?`<div class="an-card"><div class="an-num" style="color:var(--violet);">${passedC}</div><div class="an-label">Passed</div></div>`:'<div></div>'}
            <div class="an-card"><div class="an-num" style="color:var(--muted);">${absentC}</div><div class="an-label">Absent</div></div>
            <div class="an-card"><div class="an-num">${markedR.length}</div><div class="an-label">Marked</div></div>
        </div>

        <!-- Grade distribution -->
        ${markedR.length?`<div style="margin-bottom:16px;"><div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;">Grade Distribution</div><div class="grade-dist">${gradeDist()}</div></div>`:''}

        <!-- Full result list -->
        <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px;">All Results (Ranked)</div>
        ${sorted.map((r,i) => {
            const isTop = r.marks === highest && !r.absent;
            const isLow = r.marks === lowest  && !r.absent && markedR.length > 1;
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 10px;border-radius:8px;margin-bottom:4px;background:${isTop?'#f0fbf6':isLow?'#fff5f5':i%2===0?'var(--bg)':'white'};">
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:11px;color:var(--muted);font-weight:700;width:18px;">${r.absent?'':i+1}</span>
                    <div><div style="font-size:13px;font-weight:600;">${esc(r.name)}</div><div style="font-size:11px;color:var(--muted);">Roll ${esc(r.roll)}</div></div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:13px;font-weight:700;color:${r.absent?'var(--muted)':r.marks<t.pass&&t.pass?'var(--rose)':'var(--ink)'};">
                        ${r.absent?'Absent':r.marks===null?'‚Äî':`${r.marks}/${t.total}`}
                    </span>
                    <div class="grade-badge ${gradeClass(r.grade)}" style="width:30px;height:30px;font-size:0.75em;">${r.absent?'AB':r.grade}</div>
                </div>
            </div>`;
        }).join('')}

        <button class="btn btn-rose" onclick="deleteTest('${t.id}')" style="margin-top:20px;font-size:0.85em;padding:10px;">üóëÔ∏è Delete This Test</button>
    `;
    document.getElementById('testDetailModal').classList.add('open');
}

function deleteTest(id) {
    if (!confirm('Delete this test record?')) return;
    db.tests = db.tests.filter(t => t.id !== id);
    saveDB(); closeTestModal(); renderTestHistory(); toast('üóëÔ∏è Test deleted');
}

// ‚îÄ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStatus() {
    const types = [{key:'mcq',label:'MCQs',emoji:'üîµ'},{key:'fill',label:'Fill-In',emoji:'‚úèÔ∏è'},{key:'vsa',label:'Very Short',emoji:'‚ö°'},{key:'short',label:'Short Type',emoji:'üìù'},{key:'long',label:'Long Type',emoji:'üìÑ'}];
    const grid  = document.getElementById('statGrid');
    grid.innerHTML = types.map(t => {
        const count=db.logs.reduce((acc,log)=>acc+log.qs.filter(q=>q.type===t.key).length,0);
        return `<div class="stat-card"><div style="font-size:1.5em;">${t.emoji}</div><div class="stat-num">${count}</div><div class="stat-label">${t.label}</div></div>`;
    }).join('');
    const total=db.logs.reduce((acc,log)=>acc+log.qs.length,0);
    grid.innerHTML+=`<div class="stat-card" style="grid-column:span 2;background:linear-gradient(135deg,#0f7b6c,#13a88f);border-color:transparent;"><div style="font-size:1.5em;">üéØ</div><div class="stat-num" style="color:white;">${total}</div><div class="stat-label" style="color:rgba(255,255,255,0.8);">Total Questions</div></div>`;
    grid.innerHTML+=`<div class="stat-card" style="grid-column:span 2;background:linear-gradient(135deg,#7c5cbf,#9b6ee8);border-color:transparent;"><div style="font-size:1.5em;">üë•</div><div class="stat-num" style="color:white;">${db.students.length}</div><div class="stat-label" style="color:rgba(255,255,255,0.8);">Students</div></div>`;
    grid.innerHTML+=`<div class="stat-card" style="grid-column:span 2;background:linear-gradient(135deg,#e67e22,#f39c12);border-color:transparent;"><div style="font-size:1.5em;">üìì</div><div class="stat-num" style="color:white;">${db.nbChecks.length}</div><div class="stat-label" style="color:rgba(255,255,255,0.8);">Notebook Checks</div></div>`;
    grid.innerHTML+=`<div class="stat-card" style="grid-column:span 2;background:linear-gradient(135deg,#2e86de,#54a0ff);border-color:transparent;"><div style="font-size:1.5em;">üìù</div><div class="stat-num" style="color:white;">${db.tests.length}</div><div class="stat-label" style="color:rgba(255,255,255,0.8);">Tests Recorded</div></div>`;

    // Progress
    const progressEl=document.getElementById('progressContent'); progressEl.innerHTML='';
    Object.keys(db.syllabus).forEach(cls=>{
        const lines=db.syllabus[cls].split('\n').filter(Boolean);
        const totalExs=lines.reduce((acc,line)=>line.includes('|')?acc+line.split('|')[1].split(',').length:acc,0);
        const doneExs=new Set(db.logs.filter(l=>l.cls===cls).map(l=>`${l.chap}|${l.ex}`)).size;
        const pct=totalExs?Math.min(100,Math.round((doneExs/totalExs)*100)):0;
        progressEl.innerHTML+=`<div style="margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <span style="font-weight:700;font-size:13px;">${cls} <span style="font-size:11px;color:var(--muted);font-weight:400;">(${db.students.filter(s=>s.cls===cls).length} students)</span></span>
                <span style="font-size:12px;color:var(--teal);font-weight:700;">${pct}%</span>
            </div>
            <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
            <div class="progress-label">${doneExs} of ${totalExs} exercises logged</div>
        </div>`;
    });

    // Notebook summary
    const nbEl=document.getElementById('nbStatusContent');
    if(db.nbChecks.length===0){nbEl.innerHTML='<p style="color:var(--muted);font-size:13px;">No notebook checks yet.</p>';}
    else{
        const byClass={};
        db.nbChecks.forEach(c=>{if(!byClass[c.cls]) byClass[c.cls]={checks:0,missing:0};byClass[c.cls].checks++;byClass[c.cls].missing+=c.records.filter(r=>r.status==='missing').length;});
        nbEl.innerHTML=Object.entries(byClass).map(([cls,d])=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px;"><span><b>${cls}</b> ‚Äî ${d.checks} check${d.checks>1?'s':''}</span><span style="color:var(--rose);font-weight:700;">${d.missing} missing</span></div>`).join('');
    }

    // Test performance summary
    const testEl=document.getElementById('testStatusContent');
    if(db.tests.length===0){testEl.innerHTML='<p style="color:var(--muted);font-size:13px;">No tests recorded yet.</p>';}
    else{
        testEl.innerHTML=db.tests.slice().reverse().slice(0,5).map(t=>{
            const mr=t.results.filter(r=>!r.absent&&r.marks!==null);
            const avg=mr.length?(mr.reduce((a,r)=>a+r.marks,0)/mr.length).toFixed(1):'‚Äî';
            const top=mr.length?Math.max(...mr.map(r=>r.marks)):'‚Äî';
            return `<div style="padding:10px 0;border-bottom:1px solid var(--border);">
                <div style="font-size:12px;color:var(--muted);font-weight:700;">${esc(t.date)} ¬∑ ${esc(t.cls)}</div>
                <div style="font-size:13px;font-weight:700;margin:3px 0;">${esc(t.name)}</div>
                <div style="display:flex;gap:10px;font-size:11px;font-weight:700;">
                    <span style="color:var(--blue);">Avg ${avg}/${t.total}</span>
                    <span style="color:var(--success);">Top ${top}</span>
                    <span style="color:var(--muted);">${mr.length} students</span>
                </div>
            </div>`;

        }).join('');
    }

    // Recent diary
    const recentEl=document.getElementById('recentLogs');
    const recent=[...db.logs].reverse().slice(0,10);
    recentEl.innerHTML=recent.length===0?'<p style="color:var(--muted);font-size:13px;">No diary entries yet.</p>'
        :recent.map(e=>`<div class="log-entry"><div class="log-meta">${e.date} ¬∑ ${e.cls} ¬∑ ${e.fa}</div><div class="log-detail">üìç ${e.chap} ‚Äî ${e.ex}</div><div class="log-qs">${e.qs.length} questions: ${e.qs.map(q=>q.id).join(', ')}</div></div>`).join('');
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYLLABUS TRACKER  (PHASE 5)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let trackerFAFilter = 'All';

// Parse syllabus text into structured data
// Returns: [ { chap, exercises: [ { name, qty, parts } ] } ]
function parseSyllabus(cls) {
    const raw = db.syllabus[cls] || '';
    return raw.split('\n').filter(Boolean).map(line => {
        const [chapPart, exPart] = line.split('|');
        if (!chapPart) return null;
        const chap = chapPart.trim();
        const exercises = (exPart || '').split(',').map(e => {
            const p = e.trim().split(':').map(s => s.trim());
            return { name: p[0] || '', qty: parseInt(p[1]) || 0, parts: parseInt(p[2]) || 0 };
        }).filter(e => e.name);
        return { chap, exercises };
    }).filter(Boolean);
}

// Get all diary logs for a class+FA filter
function getLogsFor(cls, fa) {
    return db.logs.filter(l => l.cls === cls && (fa === 'All' || l.fa === fa));
}

// Build a Set of "chap|||ex" keys that have been logged
function buildDoneSet(cls, fa) {
    const logs = getLogsFor(cls, fa);
    const done = new Set();
    logs.forEach(l => done.add(`${l.chap}|||${l.ex}`));
    return done;
}

// Count total questions logged for a specific chap+ex ‚Äî uses prebuilt cache for performance
function buildLogCache(cls, fa) {
    const cache = {}; // key: "chap|||ex" -> array of log entries
    getLogsFor(cls, fa).forEach(l => {
        const key = `${l.chap}|||${l.ex}`;
        if (!cache[key]) cache[key] = [];
        cache[key].push(l);
    });
    return cache;
}
function countLoggedQsFromCache(cache, chap, exName) {
    const key = `${chap}|||${exName}`;
    return (cache[key] || []).reduce((sum, l) => sum + l.qs.length, 0);
}
function countLoggedQs(cls, fa, chap, exName) {
    return getLogsFor(cls, fa)
        .filter(l => l.chap === chap && l.ex === exName)
        .reduce((sum, l) => sum + l.qs.length, 0);
}

// Get all FA options assigned to a class
function getFAsForClass(cls) {
    const fas = new Set(['All']);
    db.logs.filter(l => l.cls === cls).forEach(l => fas.add(l.fa));
    const order = ['All','FA 1','FA 2','FA 3','FA 4','FA 5','FA 6'];
    return order.filter(f => fas.has(f));
}

function renderTracker() {
    const cls = document.getElementById('trackerClass').value;
    if (!cls) return;

    // FA pills
    const fas = getFAsForClass(cls);
    if (!fas.includes(trackerFAFilter)) trackerFAFilter = 'All';
    document.getElementById('trackerFAPills').innerHTML = fas.map(f =>
        `<div class="fa-pill ${trackerFAFilter===f?'active':''}" onclick="setTrackerFA('${f}')">${f}</div>`
    ).join('');

    const chapters = parseSyllabus(cls);
    const doneSet  = buildDoneSet(cls, trackerFAFilter);
    const logCache = buildLogCache(cls, trackerFAFilter); // performance cache

    // ‚îÄ‚îÄ Overview stats ‚îÄ‚îÄ
    let totalEx = 0, doneEx = 0, inProgEx = 0;
    chapters.forEach(ch => {
        ch.exercises.forEach(ex => {
            totalEx++;
            const key     = `${ch.chap}|||${ex.name}`;
            const logged  = countLoggedQsFromCache(logCache, ch.chap, ex.name);
            const totalQs = ex.qty + (ex.parts > 1 ? ex.qty * (ex.parts - 1) : 0);
            if (doneSet.has(key) && logged >= totalQs) doneEx++;
            else if (logged > 0) inProgEx++;
        });
    });
    const pendingEx = totalEx - doneEx - inProgEx;
    const pct       = totalEx ? Math.round((doneEx / totalEx) * 100) : 0;

    // Ring
    const R = 40; const C = 2 * Math.PI * R;
    const offset = C - (pct / 100) * C;
    document.getElementById('trackerOverview').innerHTML = `
        <div class="tracker-overview">
            <div class="ring-wrap">
                <svg class="ring-svg" width="100" height="100" viewBox="0 0 100 100">
                    <circle class="ring-bg"   cx="50" cy="50" r="${R}"/>
                    <circle class="ring-fill" cx="50" cy="50" r="${R}"
                        stroke-dasharray="${C}" stroke-dashoffset="${offset}"/>
                </svg>
                <div class="ring-text">${pct}%<small>done</small></div>
            </div>
            <div class="tracker-overview-info">
                <h3>${cls} ${trackerFAFilter !== 'All' ? '¬∑ '+trackerFAFilter : ''}</h3>
                <p>${chapters.length} chapters ¬∑ ${totalEx} exercises total</p>
                <div class="overview-chips">
                    <span class="ov-chip ov-chip-done">‚úÖ ${doneEx} Done</span>
                    <span class="ov-chip ov-chip-pending">‚è≥ ${inProgEx} In Progress</span>
                    <span class="ov-chip ov-chip-locked">üî≤ ${pendingEx} Pending</span>
                </div>
            </div>
        </div>`;

    // ‚îÄ‚îÄ Chapter blocks ‚îÄ‚îÄ
    const container = document.getElementById('trackerChapters');
    container.innerHTML = '';

    chapters.forEach((ch, ci) => {
        let chDone = 0, chInProg = 0, chTotal = ch.exercises.length;

        const exHTML = ch.exercises.map(ex => {
            const key     = `${ch.chap}|||${ex.name}`;
            const totalQs = ex.qty + (ex.parts > 1 ? ex.qty * (ex.parts - 1) : 0);
            const logged  = countLoggedQsFromCache(logCache, ch.chap, ex.name);
            const isDone  = doneSet.has(key) || (totalQs > 0 && logged >= totalQs);
            const isInProg= !isDone && logged > 0;

            if (isDone)   chDone++;
            else if (isInProg) chInProg++;

            // Gather diary entries for this ex
            const logs = (logCache[`${ch.chap}|||${ex.name}`] || []).slice(-3);

            const logsHTML = logs.length ? `
                <div class="ex-logs">
                    ${logs.map(l => `<div class="ex-log-row">üìÖ <span>${l.date}</span> ‚Äî ${l.qs.length} Qs (${[...new Set(l.qs.map(q=>q.type))].join(', ')})</div>`).join('')}
                </div>` : '';

            const statusClass = isDone ? 'done' : isInProg ? 'in-prog' : 'pending';
            const badgeClass  = isDone ? 'badge-done' : isInProg ? 'badge-partial' : 'badge-pending';
            const badgeText   = isDone ? '‚úÖ Done' : isInProg ? `‚è≥ ${logged}/${totalQs} Qs` : 'üî≤ Pending';
            const icon        = isDone ? '‚úÖ' : isInProg ? '‚ö°' : '‚óã';

            return `<div class="ex-row ${statusClass}">
                <span class="ex-icon">${icon}</span>
                <div style="flex:1;min-width:0;">
                    <div class="ex-name">${ex.name}</div>
                    <div class="ex-detail">${ex.qty} questions${ex.parts>1?' ¬∑ '+ex.parts+' parts each':''}</div>
                    ${logsHTML}
                </div>
                <span class="ex-badge ${badgeClass}">${badgeText}</span>
            </div>`;
        }).join('');

        const chPct   = chTotal ? Math.round(((chDone + chInProg * 0.5) / chTotal) * 100) : 0;
        const allDone = chDone === chTotal && chTotal > 0;
        const anyProg = chInProg > 0 || chDone > 0;
        const blockClass = allDone ? 'all-done' : anyProg ? 'in-progress' : 'not-started';
        const iconClass  = allDone ? 'icon-done' : anyProg ? 'icon-progress' : 'icon-pending';
        const chapIcon   = allDone ? '‚úÖ' : anyProg ? 'üìñ' : 'üìò';

        const block = document.createElement('div');
        block.className = `chapter-block ${blockClass}`;
        block.id = `chblock-${ci}`;
        block.innerHTML = `
            <div class="chapter-header" onclick="toggleChapter(${ci})">
                <div class="chapter-icon ${iconClass}">${chapIcon}</div>
                <div class="chapter-info">
                    <div class="chapter-name">${ch.chap}</div>
                    <div class="chapter-sub">${chDone}/${chTotal} exercises done${chInProg>0?' ¬∑ '+chInProg+' in progress':''}</div>
                </div>
                <div class="chapter-pct">${Math.round((chDone/Math.max(chTotal,1))*100)}%</div>
                <div class="chapter-chevron">‚ñæ</div>
            </div>
            <div class="chapter-bar-wrap">
                <div class="ch-bar-bg">
                    <div class="ch-bar-fill" style="width:${chPct}%"></div>
                </div>
                ${exHTML}
            </div>`;
        container.appendChild(block);

        // Auto-open in-progress chapters
        if (anyProg && !allDone) toggleChapter(ci);
    });
}

function setTrackerFA(fa) {
    trackerFAFilter = fa;
    renderTracker();
}

function toggleChapter(ci) {
    const block = document.getElementById(`chblock-${ci}`);
    if (block) block.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ANALYTICS ENGINE  (PHASE 6)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const GRADE_COLORS = { 'A+':'#0f7b6c', 'A':'#13a88f', 'B':'#2e86de', 'C':'#f5a623', 'D':'#e67e22', 'F':'#e05263', 'AB':'#aaa', '‚Äî':'#ccc' };

function renderAnalytics() {
    const cls     = document.getElementById('anClass').value;
    const testSel = document.getElementById('anTest');

    // Rebuild test dropdown for this class, preserving current selection if possible
    const classTests = db.tests.filter(t => t.cls === cls).sort((a,b) => a.date.localeCompare(b.date));
    const prevSelectedId = testSel.value; // capture before rebuilding
    testSel.innerHTML = '<option value="all">‚Äî All Tests (Overview) ‚Äî</option>';
    classTests.forEach(t => testSel.add(new Option(`${t.date} ¬∑ ${t.name}`, t.id)));
    // Restore previous selection if still valid for this class
    if (prevSelectedId && prevSelectedId !== 'all' && classTests.find(t => t.id === prevSelectedId)) {
        testSel.value = prevSelectedId;
    } else {
        testSel.value = 'all';
    }

    const selectedId = testSel.value;

    if (classTests.length === 0) {
        document.getElementById('anKPI').innerHTML = `<div class="card"><div class="no-data"><div class="nd-icon">üìù</div>No tests recorded for <b>${esc(cls)}</b> yet.<br><br><button class="btn btn-blue" onclick="showPage('tests',document.querySelector('.tab:nth-child(5)'));document.querySelector('.tab:nth-child(5)').classList.add('active');" style="width:auto;padding:10px 20px;font-size:0.9em;margin-top:0;">Go to Tests tab ‚Üí</button></div></div>`;
        ['anChartCard','anGradeCard','anTrendCard','anLeaderCard','anAttentionCard'].forEach(id => document.getElementById(id).style.display = 'none');
        return;
    }

    if (selectedId === 'all') {
        renderOverviewAnalytics(cls, classTests);
    } else {
        const test = classTests.find(t => t.id === selectedId);
        if (test) renderSingleTestAnalytics(test);
    }
}

// ‚îÄ‚îÄ OVERVIEW: all tests for a class ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOverviewAnalytics(cls, tests) {
    // Aggregate across all tests
    const allResults = tests.flatMap(t => t.results.filter(r => !r.absent && r.marks !== null).map(r => ({ ...r, pct: (r.marks / t.total) * 100 })));
    const avgAll  = allResults.length ? (allResults.reduce((s,r)=>s+r.pct,0)/allResults.length).toFixed(1) : '‚Äî';
    const topAll  = allResults.length ? Math.max(...allResults.map(r=>r.pct)).toFixed(1) : '‚Äî';
    const passing = allResults.filter(r => r.pct >= 33).length;
    const total   = allResults.length;
    const passRate= total ? Math.round((passing/total)*100) : 0;

    // KPI
    document.getElementById('anKPI').innerHTML = `
        <div class="card">
            <div class="kpi-row">
                <div class="kpi-card"><div class="kpi-num" style="color:var(--blue);">${tests.length}</div><div class="kpi-lbl">Tests</div></div>
                <div class="kpi-card"><div class="kpi-num" style="color:var(--teal);">${avgAll}%</div><div class="kpi-lbl">Avg Score</div></div>
                <div class="kpi-card"><div class="kpi-num" style="color:var(--violet);">${passRate}%</div><div class="kpi-lbl">Pass Rate</div></div>
            </div>
        </div>`;

    // Class avg trend chart (one bar per test)
    document.getElementById('anTrendCard').style.display = 'block';
    document.getElementById('anChartCard').style.display = 'none';
    document.getElementById('anGradeCard').style.display = 'none';

    const trendData = tests.map(t => {
        const r = t.results.filter(r => !r.absent && r.marks !== null);
        const avg = r.length ? r.reduce((s,x)=>s+x.marks,0)/r.length : 0;
        return { label: t.name.slice(0,14), pct: t.total ? (avg/t.total)*100 : 0 };
    });
    renderTrendChart(trendData);

    // Per-student aggregated leaderboard
    document.getElementById('anLeaderCard').style.display = 'block';
    const studentMap = {};
    tests.forEach(t => {
        t.results.filter(r => !r.absent && r.marks !== null).forEach(r => {
            if (!studentMap[r.studentId]) studentMap[r.studentId] = { name: r.name, scores: [], roll: r.roll };
            studentMap[r.studentId].scores.push((r.marks / t.total) * 100);
        });
    });
    const leaderRows = Object.values(studentMap)
        .map(s => ({ ...s, avg: s.scores.reduce((a,b)=>a+b,0)/s.scores.length }))
        .sort((a,b) => b.avg - a.avg);
    renderLeaderboard(leaderRows, true);

    // Needs attention
    document.getElementById('anAttentionCard').style.display = 'block';
    renderAttention(leaderRows);
}

// ‚îÄ‚îÄ SINGLE TEST: detailed view ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSingleTestAnalytics(test) {
    const results = test.results.filter(r => !r.absent && r.marks !== null);
    const absent  = test.results.filter(r => r.absent).length;
    const avg     = results.length ? results.reduce((s,r)=>s+r.marks,0)/results.length : 0;
    const highest = results.length ? Math.max(...results.map(r=>r.marks)) : 0;
    const lowest  = results.length ? Math.min(...results.map(r=>r.marks)) : 0;
    const passed  = test.pass  ? results.filter(r=>r.marks>=test.pass).length : null;
    const passRate= test.pass && results.length ? Math.round((passed/results.length)*100) : null;

    // KPI
    document.getElementById('anKPI').innerHTML = `
        <div class="card">
            <div class="kpi-row">
                <div class="kpi-card"><div class="kpi-num" style="color:var(--teal);">${avg.toFixed(1)}</div><div class="kpi-lbl">Avg / ${test.total}</div></div>
                <div class="kpi-card"><div class="kpi-num" style="color:var(--success);">${highest}</div><div class="kpi-lbl">Highest</div></div>
                <div class="kpi-card"><div class="kpi-num" style="color:var(--rose);">${lowest}</div><div class="kpi-lbl">Lowest</div></div>
            </div>
            <div class="kpi-row" style="margin-top:10px;">
                <div class="kpi-card"><div class="kpi-num" style="color:var(--violet);">${passRate !== null ? passRate+'%' : '‚Äî'}</div><div class="kpi-lbl">Pass Rate</div></div>
                <div class="kpi-card"><div class="kpi-num" style="color:var(--muted);">${absent}</div><div class="kpi-lbl">Absent</div></div>
                <div class="kpi-card"><div class="kpi-num">${results.length}</div><div class="kpi-lbl">Appeared</div></div>
            </div>
        </div>`;

    // Score distribution chart (buckets of 10%)
    document.getElementById('anChartCard').style.display = 'block';
    renderScoreDistChart(results, test.total);

    // Grade breakdown
    document.getElementById('anGradeCard').style.display = 'block';
    renderGradeDist(results, test.total);

    // Hide trend for single test
    document.getElementById('anTrendCard').style.display = 'none';

    // Leaderboard for this test
    document.getElementById('anLeaderCard').style.display = 'block';
    const leaderRows = [...results]
        .sort((a,b) => b.marks - a.marks)
        .map(r => ({ name: r.name, roll: r.roll, scores: [r.marks / test.total * 100], avg: r.marks / test.total * 100, marks: r.marks, total: test.total }));
    renderLeaderboard(leaderRows, false);

    // Attention
    document.getElementById('anAttentionCard').style.display = 'block';
    renderAttention(leaderRows);
}

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderScoreDistChart(results, total) {
    // 10 buckets: 0-9, 10-19 ... 90-100
    const buckets = Array(10).fill(0);
    results.forEach(r => {
        const pct = (r.marks / total) * 100;
        const bi  = Math.min(9, Math.floor(pct / 10));
        buckets[bi]++;
    });

    const maxCount = Math.max(...buckets, 1);
    const W = 320, H = 140, barW = 24, gap = 8, padL = 24, padB = 30;
    const totalW = Math.max(W, buckets.length * (barW + gap) + padL + 10);

    const barsHTML = buckets.map((cnt, i) => {
        const x    = padL + i * (barW + gap);
        const barH = Math.max(2, (cnt / maxCount) * (H - padB - 10));
        const y    = H - padB - barH;
        const label= `${i*10}-${i*10+9}%`;
        const color= i < 3 ? '#e05263' : i < 5 ? '#e67e22' : i < 7 ? '#f5a623' : '#0f7b6c';
        return `
            <rect class="bar-rect" x="${x}" y="${y}" width="${barW}" height="${barH}" rx="3" fill="${color}" opacity="0.85"/>
            <text x="${x+barW/2}" y="${y-4}" text-anchor="middle" font-size="9" fill="#7a8b8a" font-family="DM Sans,sans-serif">${cnt>0?cnt:''}</text>
            <text x="${x+barW/2}" y="${H-2}" text-anchor="middle" font-size="8" fill="#7a8b8a" font-family="DM Sans,sans-serif">${i*10}</text>`;
    }).join('');

    document.getElementById('anChart').innerHTML = `
        <svg class="chart-svg" width="${totalW}" height="${H}" viewBox="0 0 ${totalW} ${H}">
            <line x1="${padL}" y1="0" x2="${padL}" y2="${H-padB}" stroke="#e0e8e6" stroke-width="1"/>
            <line x1="${padL}" y1="${H-padB}" x2="${totalW}" y2="${H-padB}" stroke="#e0e8e6" stroke-width="1"/>
            ${barsHTML}
            <text x="${totalW/2}" y="${H}" text-anchor="middle" font-size="9" fill="#7a8b8a" font-family="DM Sans,sans-serif">Score Range (%)</text>
        </svg>`;
}

function renderTrendChart(trendData) {
    const W = Math.max(340, trendData.length * 60 + 40);
    const H = 140; const padL = 30; const padB = 40;
    const barW = 32; const gap = 28;
    const maxPct = 100;

    const barsHTML = trendData.map((d, i) => {
        const x    = padL + i * (barW + gap);
        const barH = Math.max(4, (d.pct / maxPct) * (H - padB - 10));
        const y    = H - padB - barH;
        const color= d.pct >= 60 ? '#0f7b6c' : d.pct >= 40 ? '#f5a623' : '#e05263';
        const shortLabel = d.label.length > 10 ? d.label.slice(0,10)+'‚Ä¶' : d.label;
        return `
            <rect class="bar-rect" x="${x}" y="${y}" width="${barW}" height="${barH}" rx="3" fill="${color}" opacity="0.85"/>
            <text x="${x+barW/2}" y="${y-5}" text-anchor="middle" font-size="9" fill="#7a8b8a" font-family="DM Sans,sans-serif">${d.pct.toFixed(0)}%</text>
            <text x="${x+barW/2}" y="${H-padB+14}" text-anchor="middle" font-size="8" fill="#7a8b8a" font-family="DM Sans,sans-serif" transform="rotate(-30,${x+barW/2},${H-padB+14})">${shortLabel}</text>`;
    }).join('');

    // Trend line connecting midpoints
    const points = trendData.map((d, i) => {
        const x    = padL + i * (barW + gap) + barW / 2;
        const barH = Math.max(4, (d.pct / maxPct) * (H - padB - 10));
        const y    = H - padB - barH - 5;
        return `${x},${y}`;
    }).join(' ');

    document.getElementById('anTrend').innerHTML = `
        <svg class="chart-svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
            <line x1="${padL}" y1="0" x2="${padL}" y2="${H-padB}" stroke="#e0e8e6" stroke-width="1"/>
            <line x1="${padL}" y1="${H-padB}" x2="${W}" y2="${H-padB}" stroke="#e0e8e6" stroke-width="1"/>
            ${barsHTML}
            ${trendData.length > 1 ? `<polyline points="${points}" fill="none" stroke="var(--ink)" stroke-width="1.5" stroke-dasharray="4 3" opacity="0.4"/>` : ''}
        </svg>`;
}

function renderGradeDist(results, total) {
    const grades = ['A+','A','B','C','D','F'];
    const counts = {};
    grades.forEach(g => counts[g] = 0);
    results.forEach(r => {
        const g = calcGrade(r.marks, total);
        if (counts[g] !== undefined) counts[g]++;
    });
    const max = Math.max(...Object.values(counts), 1);

    document.getElementById('anGradeDist').innerHTML = grades.map(g => `
        <div class="h-bar-row">
            <div class="h-bar-label" style="color:${GRADE_COLORS[g]};">${g}</div>
            <div class="h-bar-track">
                <div class="h-bar-fill" style="width:${(counts[g]/max)*100}%;background:${GRADE_COLORS[g]};opacity:0.85;"></div>
            </div>
            <div class="h-bar-count">${counts[g]}</div>
        </div>`).join('');
}

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLeaderboard(rows, showSpark) {
    if (rows.length === 0) {
        document.getElementById('anLeaderboard').innerHTML = '<div class="no-data"><div class="nd-icon">üë§</div>No student results found.</div>';
        return;
    }
    document.getElementById('anLeaderboard').innerHTML = `
        <div style="overflow-x:auto;">
        <table class="perf-table">
            <thead><tr>
                <th>#</th>
                <th>Student</th>
                <th>Avg %</th>
                <th>Score Bar</th>
                ${showSpark ? '<th>Tests</th>' : '<th>Marks</th>'}
            </tr></thead>
            <tbody>
            ${rows.map((r, i) => {
                const color  = avatarColor(r.name);
                const pctFmt = r.avg.toFixed(1);
                const barCol = r.avg >= 60 ? '#0f7b6c' : r.avg >= 33 ? '#f5a623' : '#e05263';
                const trend  = showSpark && r.scores.length > 1
                    ? trendArrow(r.scores)
                    : '';
                return `<tr>
                    <td class="perf-rank">${i+1}</td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="nb-avatar" style="background:${color};width:28px;height:28px;font-size:0.7em;">${initials2(r.name)}</div>
                            <div>
                                <div class="perf-name">${esc(r.name)}</div>
                                <div class="perf-sub">Roll ${esc(r.roll)}</div>
                            </div>
                        </div>
                    </td>
                    <td style="font-weight:800;color:${barCol};">${pctFmt}%</td>
                    <td>
                        <div class="perf-bar-wrap">
                            <div class="perf-bar-bg">
                                <div class="perf-bar-fill" style="width:${Math.min(100,r.avg)}%;background:${barCol};"></div>
                            </div>
                        </div>
                    </td>
                    <td style="font-size:12px;color:var(--muted);font-weight:700;">
                        ${showSpark ? `${r.scores.length} ${trend}` : `${r.marks}/${r.total}`}
                    </td>
                </tr>`;
            }).join('')}
            </tbody>
        </table></div>`;
}

// ‚îÄ‚îÄ NEEDS ATTENTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAttention(rows) {
    const weak = rows.filter(r => r.avg < 40);
    const el   = document.getElementById('anAttention');

    if (weak.length === 0) {
        el.innerHTML = `<div style="text-align:center;padding:16px;color:var(--teal);font-weight:700;font-size:13px;">‚úÖ All students are performing above 40%!</div>`;
        return;
    }

    el.innerHTML = weak.map(r => {
        const color  = avatarColor(r.name);
        const trend  = r.scores.length > 1 ? trendArrow(r.scores) : '';
        const reason = r.avg < 20 ? 'Critical ‚Äî Below 20%' : r.avg < 33 ? 'Failing ‚Äî Below 33%' : 'Weak ‚Äî Below 40%';
        return `<div class="attention-card">
            <div class="attention-avatar" style="background:${color};">${initials2(r.name)}</div>
            <div class="attention-info">
                <div class="attention-name">${esc(r.name)} <span style="font-size:11px;color:var(--muted);">Roll ${esc(r.roll)}</span></div>
                <div class="attention-reason">${esc(reason)} ${trend}</div>
            </div>
            <div class="attention-score">${r.avg.toFixed(0)}%</div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function trendArrow(scores) {
    if (scores.length < 2) return '';
    const last  = scores[scores.length - 1];
    const prev  = scores[scores.length - 2];
    const diff  = last - prev;
    if (diff > 3)  return '<span class="trend-up">‚Üë</span>';
    if (diff < -3) return '<span class="trend-down">‚Üì</span>';
    return '<span class="trend-flat">‚Üí</span>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BULK STUDENT UPLOAD  (CSV / Excel / PDF)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let bulkParsedRows = []; // holds parsed + validated rows before final import

// ‚îÄ‚îÄ Column name aliases ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COL_MAP = {
    roll:    ['roll','roll no','roll number','sr','sr no','sr.no','sno','s.no','serial','serial no'],
    first:   ['first name','firstname','name','student name','first','given name'],
    last:    ['last name','lastname','surname','last','family name'],
    class:   ['class','grade','std','standard','class name'],
    section: ['section','div','division','sec'],
    gender:  ['gender','sex'],
    parent:  ['parent','father','guardian','parent name','father name','guardian name'],
    contact: ['contact','phone','mobile','whatsapp','contact no','phone no','mobile no'],
    remarks: ['remarks','notes','note','comment','comments'],
};

function normalizeHeader(h) {
    return (h||'').toString().trim().toLowerCase().replace(/[^a-z0-9 ]/g,'');
}

function mapHeaders(headerRow) {
    const map = {}; // field -> column index
    headerRow.forEach((h, i) => {
        const norm = normalizeHeader(h);
        for (const [field, aliases] of Object.entries(COL_MAP)) {
            if (aliases.includes(norm) && map[field] === undefined) {
                map[field] = i;
            }
        }
    });
    return map;
}

function getCell(row, map, field) {
    const idx = map[field];
    if (idx === undefined) return '';
    return (row[idx] ?? '').toString().trim();
}

// ‚îÄ‚îÄ File handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleBulkDrop(e) {
    e.preventDefault();
    document.getElementById('bulkDropZone').classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) processBulkFile(file);
}

function handleBulkFile(e) {
    const file = e.target.files[0];
    if (file) processBulkFile(file);
    e.target.value = '';
}

function processBulkFile(file) {
    const name = file.name.toLowerCase();
    showBulkStatus('‚è≥ Reading file‚Ä¶', 'var(--muted)');
    if (name.endsWith('.csv')) {
        readAsText(file, parseCSV);
    } else if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
        readAsArrayBuffer(file, parseExcel);
    } else if (name.endsWith('.pdf')) {
        readAsArrayBuffer(file, parsePDF);
    } else {
        showBulkStatus('‚ùå Unsupported file type. Please use CSV, Excel, or PDF.', 'var(--rose)');
    }
}

function readAsText(file, callback) {
    const reader = new FileReader();
    reader.onload = e => callback(e.target.result);
    reader.onerror = () => showBulkStatus('‚ùå Could not read file.', 'var(--rose)');
    reader.readAsText(file);
}

function readAsArrayBuffer(file, callback) {
    const reader = new FileReader();
    reader.onload = e => callback(e.target.result);
    reader.onerror = () => showBulkStatus('‚ùå Could not read file.', 'var(--rose)');
    reader.readAsArrayBuffer(file);
}

// ‚îÄ‚îÄ CSV Parser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) { showBulkStatus('‚ùå CSV has no data rows.', 'var(--rose)'); return; }
    const headers = splitCSVLine(lines[0]);
    const map = mapHeaders(headers);
    if (map.roll === undefined || map.first === undefined) {
        showBulkStatus('‚ùå Could not find required columns (Roll, First Name). Check your headers.', 'var(--rose)');
        return;
    }
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const cells = splitCSVLine(lines[i]);
        if (cells.every(c => !c.trim())) continue;
        rows.push(buildStudentRow(cells, map, i + 1));
    }
    showBulkPreview(rows);
}

function splitCSVLine(line) {
    // Handles quoted fields with commas
    const result = [];
    let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') { inQ = !inQ; }
        else if (ch === ',' && !inQ) { result.push(cur.trim()); cur = ''; }
        else { cur += ch; }
    }
    result.push(cur.trim());
    return result;
}

// ‚îÄ‚îÄ Excel Parser (SheetJS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseExcel(buffer) {
    try {
        const wb = XLSX.read(buffer, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const raw = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        if (raw.length < 2) { showBulkStatus('‚ùå Excel sheet has no data rows.', 'var(--rose)'); return; }
        const headers = raw[0].map(h => (h||'').toString());
        const map = mapHeaders(headers);
        if (map.roll === undefined || map.first === undefined) {
            showBulkStatus('‚ùå Could not find required columns (Roll, First Name). Check your headers.', 'var(--rose)');
            return;
        }
        const rows = [];
        for (let i = 1; i < raw.length; i++) {
            if (raw[i].every(c => !(c||'').toString().trim())) continue;
            rows.push(buildStudentRow(raw[i].map(c => (c??'').toString()), map, i + 1));
        }
        showBulkPreview(rows);
    } catch(e) {
        showBulkStatus('‚ùå Could not parse Excel file: ' + e.message, 'var(--rose)');
    }
}

// ‚îÄ‚îÄ PDF Parser (PDF.js) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function parsePDF(buffer) {
    try {
        if (typeof pdfjsLib === 'undefined') {
            showBulkStatus('‚ùå PDF library not loaded. Check your internet connection.', 'var(--rose)');
            return;
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        showBulkStatus('‚è≥ Parsing PDF‚Ä¶', 'var(--muted)');
        const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
        let fullText = '';
        for (let p = 1; p <= pdf.numPages; p++) {
            const page = await pdf.getPage(p);
            const content = await page.getTextContent();
            // Group items by Y position to reconstruct rows
            const byY = {};
            content.items.forEach(item => {
                const y = Math.round(item.transform[5]);
                if (!byY[y]) byY[y] = [];
                byY[y].push({ x: item.transform[4], text: item.str });
            });
            // Sort rows top-to-bottom, items left-to-right
            Object.keys(byY).sort((a,b) => b-a).forEach(y => {
                const lineItems = byY[y].sort((a,b) => a.x-b.x);
                fullText += lineItems.map(i => i.text).join('\t') + '\n';
            });
        }
        parsePDFText(fullText);
    } catch(e) {
        showBulkStatus('‚ùå Could not parse PDF: ' + e.message, 'var(--rose)');
    }
}

function parsePDFText(text) {
    // Split by lines, try to detect table structure
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (lines.length < 2) { showBulkStatus('‚ùå Could not extract table data from PDF.', 'var(--rose)'); return; }

    // Detect delimiter: tab-separated or space-separated columns
    const headerLine = lines[0];
    const isTabSep = headerLine.includes('\t');
    const splitLine = l => isTabSep
        ? l.split('\t').map(s => s.trim())
        : l.split(/\s{2,}/).map(s => s.trim()); // 2+ spaces as delimiter

    const headers = splitLine(lines[0]);
    const map = mapHeaders(headers);

    if (map.roll === undefined || map.first === undefined) {
        // Try treating entire PDF as a name list (one name per line, no headers)
        parsePDFNameList(lines);
        return;
    }

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const cells = splitLine(lines[i]);
        if (!cells.some(c => c)) continue;
        rows.push(buildStudentRow(cells, map, i + 1));
    }
    showBulkPreview(rows);
}

function parsePDFNameList(lines) {
    // Fallback: treat as numbered list of names ‚Äî "1. Ayesha Khan" or "1 Ayesha Khan"
    const rows = [];
    let rollCounter = 1;
    const clsKeys = Object.keys(db.syllabus);
    const defaultClass = clsKeys[0] || 'Class 6';

    lines.forEach((line, i) => {
        // Match: optional number, then name
        const m = line.match(/^(\d+)[.\):\s]+(.+)$/);
        if (!m && !/^[A-Z]/.test(line)) return; // skip non-name lines

        const roll = m ? m[1] : String(rollCounter++);
        const fullName = (m ? m[2] : line).trim();
        const parts = fullName.split(/\s+/);
        const first = parts[0] || '';
        const last = parts.slice(1).join(' ') || '';

        if (!first) return;
        rows.push({
            roll, first, last,
            cls: defaultClass, section: '', gender: '', parent: '', contact: '', remarks: '',
            srcLine: i + 1,
            issues: [], valid: true,
        });
    });

    if (rows.length === 0) {
        showBulkStatus('‚ùå Could not find student data in PDF. Try CSV or Excel instead.', 'var(--rose)');
        return;
    }
    // Warn that class was guessed
    rows.forEach(r => r.issues.push(`Class set to "${r.cls}" ‚Äî please verify`));
    showBulkPreview(rows);
}

// ‚îÄ‚îÄ Row Builder + Validator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildStudentRow(cells, map, srcLine) {
    const roll    = getCell(cells, map, 'roll');
    const first   = toTitleCase(getCell(cells, map, 'first'));
    // If only "name" column exists, split it
    let last = toTitleCase(getCell(cells, map, 'last'));
    if (!last && first.includes(' ')) {
        const parts = first.split(' ');
        // first word = first name, rest = last
        return buildStudentRow(cells, map, srcLine); // will be handled below
    }
    const rawCls  = getCell(cells, map, 'class');
    const section = getCell(cells, map, 'section');
    const gender  = normalizeGender(getCell(cells, map, 'gender'));
    const parent  = toTitleCase(getCell(cells, map, 'parent'));
    const contact = getCell(cells, map, 'contact').replace(/\D/g,'');
    const remarks = getCell(cells, map, 'remarks');

    // Handle "name" column being full name
    let firstName = first, lastName = last;
    if (!lastName && firstName.includes(' ')) {
        const parts = firstName.split(' ');
        firstName = parts[0];
        lastName = parts.slice(1).join(' ');
    }

    // Resolve class name
    const cls = resolveClass(rawCls);

    // Validate
    const issues = [];
    let valid = true;

    if (!roll)                         { issues.push('Missing roll number'); valid = false; }
    if (!firstName)                    { issues.push('Missing first name'); valid = false; }
    if (!cls)                          { issues.push(`Class "${rawCls}" not in syllabus`); valid = false; }
    if (db.students.find(s => s.roll === roll && s.cls === cls)) {
        issues.push(`Roll ${roll} already exists in ${cls}`);
        valid = false;
    }

    return { roll, first: firstName, last: lastName, cls: cls||rawCls, section, gender, parent, contact, remarks, srcLine, issues, valid };
}

function resolveClass(raw) {
    if (!raw) return null;
    const norm = raw.toString().toLowerCase().trim();
    // Exact match
    const exact = Object.keys(db.syllabus).find(k => k.toLowerCase() === norm);
    if (exact) return exact;
    // Partial: "6" ‚Üí "Class 6", "class6" ‚Üí "Class 6"
    const num = norm.replace(/[^0-9]/g,'');
    if (num) {
        const byNum = Object.keys(db.syllabus).find(k => k.replace(/[^0-9]/g,'') === num);
        if (byNum) return byNum;
    }
    return null;
}

function normalizeGender(g) {
    const l = (g||'').toLowerCase().trim();
    if (['m','male','boy','b'].includes(l)) return 'Male';
    if (['f','female','girl','g'].includes(l)) return 'Female';
    return g;
}

function toTitleCase(str) {
    return (str||'').replace(/\w\S*/g, t => t.charAt(0).toUpperCase() + t.slice(1).toLowerCase());
}

// ‚îÄ‚îÄ Preview ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showBulkPreview(rows) {
    bulkParsedRows = rows;
    if (rows.length === 0) {
        showBulkStatus('‚ö†Ô∏è No student rows found in the file.', 'var(--orange)');
        return;
    }

    const valid   = rows.filter(r => r.valid).length;
    const invalid = rows.length - valid;

    document.getElementById('bulkPreviewCount').textContent =
        `${rows.length} rows found ‚Äî ${valid} valid, ${invalid} with issues`;

    const tbody = document.getElementById('bulkPreviewBody');
    tbody.innerHTML = rows.map(r => {
        const rowClass = r.valid ? 'bulk-row-ok' : (r.issues.length > 0 && r.first ? 'bulk-row-warn' : 'bulk-row-err');
        const status   = r.valid
            ? '<span class="bulk-status-ok">‚úÖ Ready</span>'
            : r.first
                ? `<span class="bulk-status-warn">‚ö†Ô∏è ${esc(r.issues.join('; '))}</span>`
                : `<span class="bulk-status-err">‚ùå ${esc(r.issues.join('; '))}</span>`;
        return `<tr class="${rowClass}">
            <td>${esc(r.roll)}</td>
            <td>${esc(r.first)}</td>
            <td>${esc(r.last)}</td>
            <td>${esc(r.cls)}</td>
            <td>${esc(r.section)}</td>
            <td>${esc(r.gender)}</td>
            <td>${esc(r.contact)}</td>
            <td>${status}</td>
        </tr>`;
    }).join('');

    // Warnings box
    const warnings = [];
    if (invalid > 0) warnings.push(`‚ö†Ô∏è ${invalid} row(s) have issues and will be skipped.`);
    const noLastName = rows.filter(r => r.valid && !r.last).length;
    if (noLastName > 0) warnings.push(`‚ÑπÔ∏è ${noLastName} student(s) have no last name ‚Äî they'll be imported with first name only.`);

    document.getElementById('bulkWarnings').innerHTML = warnings.length
        ? `<div class="bulk-warning-box">${warnings.join('<br>')}</div>` : '';

    document.getElementById('bulkImportBtn').textContent = `‚úÖ Import ${valid} Valid Student${valid !== 1 ? 's' : ''}`;
    document.getElementById('bulkImportBtn').disabled = valid === 0;

    document.getElementById('bulkPreview').style.display = 'block';
    document.getElementById('bulkStatus').style.display = 'none';
    document.getElementById('bulkPreview').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function cancelBulkImport() {
    bulkParsedRows = [];
    document.getElementById('bulkPreview').style.display = 'none';
    document.getElementById('bulkStatus').style.display = 'none';
}

function confirmBulkImport() {
    const toImport = bulkParsedRows.filter(r => r.valid);
    if (toImport.length === 0) { toast('‚ö†Ô∏è No valid rows to import'); return; }

    let added = 0, skipped = 0;
    toImport.forEach(r => {
        // Re-check for duplicates (in case student was added since preview)
        if (db.students.find(s => s.roll === r.roll && s.cls === r.cls)) { skipped++; return; }
        db.students.push({
            id: Date.now().toString() + Math.random().toString(36).slice(2,6),
            first: r.first, last: r.last, roll: r.roll, cls: r.cls,
            section: r.section, gender: r.gender, parent: r.parent,
            contact: r.contact, countryCode: '+91', remarks: r.remarks,
            addedOn: localToday(),
        });
        added++;
    });

    saveDB();
    renderStudents();
    buildClassPills();
    cancelBulkImport();

    const msg = skipped > 0
        ? `‚úÖ ${added} student${added!==1?'s':''} imported! (${skipped} skipped ‚Äî duplicates)`
        : `‚úÖ ${added} student${added!==1?'s':''} imported successfully!`;
    showBulkStatus(msg, 'var(--teal)');
    toast(msg);
}

function showBulkStatus(msg, color) {
    const el = document.getElementById('bulkStatus');
    el.style.display = 'block';
    el.innerHTML = `<div style="padding:14px;border-radius:10px;background:var(--bg);border:1.5px solid var(--border);font-size:13px;font-weight:600;color:${color};">${msg}</div>`;
}

function toggleBulkFormat() {
    const panel = document.getElementById('bulkFormatPanel');
    const chevron = document.getElementById('bulkFormatChevron');
    const open = panel.style.display === 'none';
    panel.style.display = open ? 'block' : 'none';
    chevron.textContent = open ? '‚ñ¥' : '‚ñæ';
}

function downloadSampleCSV() {
    const csv = [
        'Roll,First Name,Last Name,Class,Section,Gender,Parent,Contact,Remarks',
        '1,Ayesha,Khan,Class 6,A,Female,Mohammad Khan,9876543210,Good in Maths',
        '2,Rahul,Sharma,Class 6,A,Male,Ramesh Sharma,9123456780,',
        '3,Priya,Verma,Class 6,B,Female,,,'
    ].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'student_upload_sample.csv';
    a.click();
    toast('‚¨á Sample CSV downloaded!');
}

</script>
</body>
</html>
